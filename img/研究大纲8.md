# 1　引言、定位与贡献地图

## 1.1　动机与问题

**现象（符号爆炸）**
满足“仿射层 + ReLU/Max 类门控 + DAG 拓扑”的网络，其输入→输出是**连续分段线性（CPWL）**函数；若用**符号树**（逐层展开的 $\max/+$ 复合）直接表示，线性片段与门控条件会被**指数级重复**枚举，导致存储与判定不可用。

**需求（共享表达）**
需要一种**可共享的 DAG 结构**，把“重复子式”合并，实现：

* **无损**表示原网络函数；
* 在该结构上**直接**进行几何（区域、梯度、边界、Lipschitz）与形式化（鲁棒、等变、等价）分析；
* 将**干预/修复**转化为可构造的优化/判定问题。

## 1.2　核心思想（方法概述）

* **权重域**：使用按点热带函数半环

  $$
  K_f=\bigl(\mathrm{CPWL}^{\pm\infty},\ \oplus=\max,\ \otimes=+\bigr),
  $$

  元素是输入空间上的 CPWL 函数（允许取 $-\infty$）。
* **守卫（guard）**：用线性不等式定义的**多面体**选择可行片段/路径。
* **表示**：引入**带多面体守卫的符号加权变换器（SWT）**：一个层到层的图算子，将“上一层的（守卫，仿射）片段表”经**守卫交集 + 权函数运算**映为下一层片段表；全网逐层编译得到**无环**的共享图。
* **判定**：把两个表示在输入空间上做**共同细分**（守卫交 + 两两比较超平面），每个细分区上两侧都退化为**单一仿射**，从而把**等价/差异/性质**判定化为**有限的仿射比较/LP/SOCP**。

> **与经典 WFA 的区别**：传统 WFA 的权为**标量**且无守卫，只能表达**全局**的 max‑of‑affine（凸情形）；SWT 的**函数权 + 多面体守卫**可无损表达**一般（含非凸）CPWL**。

## 1.3　基本事实（用于后续理论的最小前置）

**命题 1（CPWL 本质）**
满足：仿射层（全连接/卷积/均值池化/推理态 BN/加法残差），门控为 ReLU/Leaky‑ReLU/PReLU/Abs/Max，计算图为 DAG 的网络，其输出各分量均为 CPWL。
**证明思路**：仿射映射保持 CPWL；ReLU/Leaky‑ReLU/PReLU/Abs/Max 都是有限个仿射的 $\max$/线性组合 ⇒ CPWL；有限次复合与加法保持 CPWL；DAG 保证复合结束。

**命题 2（符号树的指数膨胀）**
把上述网络逐层展开为 $\max/+$ 的语法树，最坏情况下片段/条件数随门控数呈 $2^{\Theta(N_{\max})}$ 增长。
**证明思路**：构造每个门独立翻转符号并影响下游选择的家族（如分离超平面），树结构无共享，路径枚举产生指数项。

**命题 3（共享 DAG 的必要性）**
**陈述**　在 A1–A6 下，固定如下计数与共享规范：
（C1）建立全局**守卫库** $\mathcal H$：收录经行归一与 tie 双侧化的全部线性比较/阈值不等式，每个守卫仅注册一次；
（C2）“**状态**＝结构位点/模板实例”，“**边**＝算子连线”，边仅保存 $\mathcal H$ 中守卫的**索引集合**（不存路径交集）；
（C3）**不把线性区域计作状态**。
则卷积/GNN 的模板与各类 Max/门控比较式**只存一次**，图规模与“**模板实例数**”及“**必要比较数**”（决定守卫数）同阶，而非与线性区域数同阶。

## 1.4　本文贡献（可检验标签）

* **AF‑1…AF‑5**：统一的 CPWL 层演算与结构性质（良定义、同态求值、连续/凸的充分条件、a.e. 可微、分层组合）。
* **SWT‑1**：从网络到 SWT 的**等价编译**（逐点一致）；**SWT‑2**：无环与规模上界；**SWT‑3**：功能等价**可判定**；**SWT‑4**：差异区域自动机；**SWT‑5**：最小实现复杂度与 NP‑难。
* **GEO‑1…GEO‑5**：线性区域显式构造、值域精确极值、决策边界复形、梯度/雅可比自动机、全局/局部 Lipschitz 精确值。
* **VER‑1…VER‑3**：性质验证（产品构造）、鲁棒认证、等变验证；**CAU‑1…CAU‑2**：干预闭包与最大因果影响；**SYN‑1…SYN‑3**：参数/结构修复与综合的可构造解法。

## 1.5　相关工作与定位

* **表示层面**：Max‑of‑Affine/热带代数仅覆盖**凸** CPWL；WFA/WTA 侧重离散字母/标量权。SWT 以**函数权 + 多面体守卫**覆盖**一般 CPWL**。
* **验证层面**：MILP、松弛（线性/半定/几何）多为“解题器‑驱动”，缺少**共享的中间几何对象**；SWT 把几何与验证统一到**一个可共享的片段图**。
* **因果/修复**：现有工作多为经验/启发式；本文把干预与修复转为 CPWL/SWT 上的**精确可判定/可优化**问题。

---

# 2　设定、适用边界与记号

## 2.1　组件与统一假设

**输入域**：$\mathcal D_{\mathrm{in}}\subseteq\mathbb R^n$，可为盒、多面体、$\ell_p$ 球等。

**支持组件（精确覆盖）**

* **线性/仿射**：全连接、卷积（含 padding/stride）、均值池化、加法残差、**推理态** BN。
* **门控/激活**：ReLU、Leaky‑ReLU、PReLU、绝对值、按点 Max/MaxPool。
* **结构**：DAG 计算图；固定图上的 GNN（图拓扑不随输入变化；聚合为 Sum/Mean/Max）。

**不纳入（需近似/不主讲）**
注意力/乘法门（LSTM/GRU）、训练态 BN（批统计随输入变化）、随机算子、循环/动态图。

**统一假设（A1–A6）**

* **A1（DAG）**：计算图无环。
* **A2（CPWL 组件）**：层仅由仿射与 ReLU/Leaky‑ReLU/PReLU/Abs/Max 组成。
* **A3（固定图）**：若为 GNN，图 $G=(V,E)$ 固定。
* **A4（推理态 BN）**：采用冻结的均值/方差。
* **A5（数值域）**：参数取实数。
* **A6（输入域）**：默认 $\mathcal D_{\mathrm{in}}$ 为盒/多面体/$\ell_p$ 球等凸域（必要时可限制在关心域）。

> **权重域选择**：为统一覆盖 Leaky‑ReLU/PReLU/Abs 的负值输出，本文采用

$$
K_f=(\mathrm{CPWL}^{\pm\infty},\ \oplus=\max,\ \otimes=+)\!,
$$

以 $S_+$（非负 CPWL）作为 ReLU/Max 的特例。所有门控在 $K_f$ 中均可表示。

## 2.2　输入结构与守卫范式

* **向量**：索引 $\{1,\dots,n\}$；守卫为线性不等式 $Ax\le d$。
* **网格（图像/特征图）**：索引 $(c,i,j)$；**滑窗守卫**编码卷积/池化的有效区域、边界与 stride；**权共享**通过模板别名（不复制数值，仅复制索引）。
* **固定图 GNN**：节点索引 $v\in V$；聚合守卫指示邻域 $\mathcal N(v)$ 的稀疏仿射/比较（Max）。

**守卫表示（统一采用 H‑形式）**

$$
\textstyle C=\{x\in\mathbb R^n:\ Ax\le d\}.
$$

组合运算：交 $C\cap C'$ 仍为 H‑形式；“比较守卫”写成 $(w^\top x+b)-(w'^\top x+b')\ge 0$。

**tie 约定**
涉及 $\max$ 或阈值的相等情形，默认采用 $\ge/\le$ 的双侧守卫同时保留；选择由 $\oplus=\max$ 在求值时解决。数值判等采用固定阈值 $\tau$（如 $10^{-7}$）以防浮点抖动。

## 2.3　记号、范数与复杂度标签

**范数与对偶**

* 向量范数 $\|\cdot\|_p$，对偶指数 $p^*$ 满足 $1/p+1/p^*=1$。
* 线性算子范数 $\|J\|_{p\to r}=\sup_{\|x\|_p=1}\|Jx\|_r$。

**几何对象**

* **多面体**：$C=\{x:Ax\le d\}$。
* **多面复形**：若干多面体的有限并，任意两块交按面相容。
* **线性区域**：$(R_\rho,\ w_\rho,b_\rho)$ 使得 $x\in R_\rho\Rightarrow F(x)=w_\rho^\top x+b_\rho$。

**算子与代数**

* $\oplus=\max$（按点）；$\otimes=+$（按点）；$\mathbf 0\equiv-\infty$、$\mathbf 1\equiv 0$。
* “路径求值”＝沿路径对仿射增量做 $\otimes$ 累加；“并行择优”＝跨路径做 $\oplus$ 取最大。

**复杂度标签（在各定理后统一引用）**

* **构造性**：给出确定性算法/构造。
* **可判定**：存在判定算法（可能昂贵）。
* **规模**：以层数、通道数、模板实例数、门控数计。
* **难度**：NP‑难/MILP/SOCP/量词消去等提示求解代价。

**默认量化域**

* 所有“全域”性质默认限制在 $\mathcal D_{\mathrm{in}}$ 上；若无特别说明，阈值比较采用闭集合约定（$\ge,\le$）。

------

# 3　CPWL 层演算与 SWT 框架（理论主干 I）

## 3.1　CPWL 层演算（AF 系列）

### **预备**

* **预激活空间**：$\mathcal P=\{f:\mathbb R^n\!\to\!\mathbb R\mid f\ \text{为 CPWL}\}$。
* **函数半环**：$K_f=(\mathrm{CPWL}^{\pm\infty},\ \oplus,\ \otimes,\ \mathbf 0,\ \mathbf 1)$，其中
  $(f\oplus g)(x)=\max\{f(x),g(x)\},\ (f\otimes g)(x)=f(x)+g(x)$,\ $\mathbf 0\equiv-\infty,\ \mathbf 1\equiv 0$。
* **典型投影/门控**（按点）：
  $\sigma_{\rm ReLU}(z)=\max\{0,z\}$,\ $\sigma_{\rm Abs}(z)=\max\{z,-z\}$,\ $\sigma_{\rm LReLU}(z)=\max\{z,\alpha z\}\ (\alpha\!\in[0,1])$,\ $\sigma_{\rm PReLU}(z)=\max\{z,\alpha z\}$（$\alpha$ 为可学习常数），\ $\sigma_{\max}(z_1,\dots,z_m)=\max_i z_i$。

### AF‑1（良定义性）

**陈述**　每层的预激活属于 $\mathcal P$；施加任一上述门控后得到的激活属于 $K_f$；CNN/GNN 逐点同理。
**证明思路**　仿射保持 CPWL；上述门控均是有限个仿射的 $\max$/线性组合，故为 CPWL；Leaky/PReLU/Abs 可能取负，因而位于 $K_f$ 而非仅非负的 $S_+$。□

### AF‑2（同态求值）

**陈述**　对任一点 $x_0$，将层演算表达按 $h_{x_0}(f)=f(x_0)$ 求值，等于数值前向结果。
**证明思路**　$\oplus,\otimes$ 为按点 $\max/\!+$；逐层：仿射相加与并行分支求和对应 $\otimes$，门控选择对应 $\oplus$。对层数做归纳即可。□

### AF‑3（结构性质：CPWL/连续；凸性的充分条件）

**陈述**　输出各分量为 CPWL 且连续；若每层**进入激活前的混合系数**$\ge 0$，且激活为**凸且单调非降**（ReLU/Max/Leaky‑ReLU/PReLU），则整体函数凸；若用 Abs，仅当其**只作用于仿射**时仍保证凸。
**证明思路**　CPWL 的仿射组合与按点 $\max$ 保持 CPWL 与连续；凸函数的非负线性组合与其在**单调非降**映射下复合保持凸；Abs 情形用“凸∘仿射＝凸”，一般复合不保证凸。□

### AF‑4（几乎处处可微）

**陈述**　CPWL 在有限多面体复形上分段仿射，a.e. 可微；每一线性区 $R_\rho$ 上 $F(x)=w_\rho^\top x+b_\rho$。
**证明思路**　标准 CPWL 性质；不可微点的 Clarke 次微分为相邻区域梯度的凸包。□

### AF‑5（组合性）

**陈述**　每层变换可写为“仿射 + 投影”的 CPWL 映射；有限次复合仍为 CPWL。
**证明思路**　对层序做结构归纳即可。□

## 3.2　SWA/SWT 的语义（SWT‑0）

**SWA（符号加权自动机）**
一个标量输出的 SWA 为七元组 $A=(Q,q_{\rm init},F,E,\mathsf G,\mathsf W,K_f)$：

* $Q$ 有限状态集，$q_{\rm init}\in Q$ 初态，$F\subseteq Q$ 终态；
* $E\subseteq Q\times Q$ 有向边；
* **守卫** $\mathsf G:E\to\{x:Ax\le d\}$（H‑形式多面体）；
* **权** $\mathsf W:E\cup Q\to K_f$（CPWL 函数）；
* 对输入 $x$，可行路径 $\pi=e_1\dots e_T$ 满足 $x\in\bigcap_t \mathsf G(e_t)$，其**路径值**
  $\mathsf{val}_A(\pi,x)=\mathsf W(q_{\rm init})(x)\otimes\bigotimes_t \mathsf W(e_t)(x)\otimes \mathsf W(q_T)(x)$；
* **输出** $A(x)=\bigoplus_{\pi:q_{\rm init}\to F,\ x\models\pi}\mathsf{val}_A(\pi,x)$。

**SWT（符号加权变换器）**
将上一层的“（守卫，仿射）片段表”映为下一层的片段表：对每个输入片段 $(C,w,b)$，按层规则（仿射累加、门控分裂、守卫交集、模板复制）生成若干输出片段，并在**同守卫**下以 $\otimes$ 合并权；所有片段以共享 DAG 连接即成新 SWA。SWT 与 SWA 复合定义逐层编译。

**与经典 WFA 的区别**
WFA 权为标量且无守卫，表达全局 max‑of‑affine（凸类）；SWA/SWT 的**函数权 + 多面体守卫**可无损表达**一般（含非凸）CPWL**。

---

# 4　从网络到 SWT 的编译与判定性

## 4.1　编译器总则（算法纲要）

**数据单元：片段** $\texttt{Piece}=(C,\ w,\ b)$，语义为“若 $x\in C$，则 $f(x)=w^\top x+b$”。
**守卫运算**：交 $C\cap C'$；**比较守卫** $\{(w^\top x+b)-(w'^\top x+b')\ge 0\}$。
**合并**：同守卫下的仿射相加（$\otimes$）。**选择**：并行候选取 $\oplus$。

* **线性/BN/残差**：对上层每片段 $(C,w,b)$ 生成
  $(C,\ \tilde w=Ww,\ \tilde b=Wb+b_0)$ 并跨来源分量在同 $C$ 下以 $\otimes$ 聚合。推理态 BN 并入仿射。残差为两支在 $C_1\cap C_2$ 上的相加。
* **ReLU / Abs**：对 $(C,w,b)$ 生成
  正区：$\bigl(C\cap\{w^\top x+b\ge 0\},\,w,\,b\bigr)$；
  负区：$\bigl(C\cap\{w^\top x+b\le 0\},\,0,\,0\bigr)$（ReLU）或 $\bigl(C\cap\{w^\top x+b\le 0\},\,-w,\,-b\bigr)$（Abs）。
  **tie**（=0）两侧并存，由 $\oplus$ 解决。
* **Leaky‑ReLU/PReLU**：同上，负区仿射改为 $(\alpha w,\ \alpha b)$。
* **Max / MaxPool**：候选 $\{(C_i,w_i,b_i)\}$ 生成赢家域
  $C_i^\star = (\bigcap_j C_j)\cap \bigcap_{j\ne i}\{(w_i-w_j)^\top x+(b_i-b_j)\ge 0\}$，在 $C_i^\star$ 上取 $(w_i,b_i)$。
* **卷积/均值池化**：为每个输出位置复制**模板**，守卫编码滑窗有效域/stride/padding；参数不复制数值，只做索引别名；均值池化为无权仿射。
* **GNN**：Sum/Mean 聚合为稀疏仿射；Max 聚合按比较守卫；更新 MLP 参照前述仿射+门控。
* **数值稳健**：守卫 H‑规范化与冗余剔除；big‑M 与指示约束用区间传播取紧界；一致阈值 $\tau$ 处理 tie 与浮点误差。

## 4.2　主定理与复杂度（SWT 系列）

### SWT‑1（等价编译）

**陈述**　按 4.1 逐层编译所得 $A_F$ 与原网络 $F$ 满足 $\forall x,\ A_F(x)=F(x)$。
**证明思路**　对层数做归纳：
(1) 仿射层：在同一守卫内的权以 $\otimes$ 累加，等同并行求和；
(2) 门控层：守卫分裂（含 tie）精确实现 $\max$/阈值逻辑；
(3) 卷积/GNN：位置/节点复制是逐点语义的展开；
路径求值与并行择优分别等同“求和/取最大”。□
**标签**：构造性，逐点一致。

### SWT‑2（无环与规模上界）

**陈述**　若计算图为 DAG，且采用（C1–C3）的**守卫库共享编译**，则编译所得 $A_F$ 无环，且存在常数 $c_1,c_2>0$ 使
$$
|Q|\le c_1\,(N_{\mathrm{lin}}+T_{\mathrm{conv}}),\qquad
|E|,\ |\mathcal H|\le c_2\,\big(N_{\mathrm{lin}}+T_{\mathrm{conv}}+G_{\mathrm{cmp}}\big),
$$

其中 $G_{\mathrm{cmp}}=\sum_{v\in\mathrm{Max}}\binom{k_v}{2}$（ReLU/Leaky/PReLU/Abs 视作 $k_v=2$），$\mathcal H$ 为全局守卫库。**交集仅在求值/判定时计算**，不在边上复制。

**证明思路**　编译仅沿前向复制/分裂并做守卫交集，不引回边 ⇒ 无环；**节点规模**线性受“仿射子层 + 模板实例”约束；**边与守卫数**由比较面数主导，守卫库全局复用避免按路径复制，故得上界。

### SWT‑3（等价可判定）

**陈述**　对两个无环 SWT，判定 $\forall x,\ A_1(x)\equiv A_2(x)$ 可判定。
**算法**　构造**共同细分**：对两侧所有守卫取交，并加入所有候选仿射的**两两比较超平面** $\{f_i\ge f_j\}$，得到有限多面体族 $\{R_\rho\}$。在每个 $R_\rho$ 上，两侧都退化为单一仿射 $w_{k,\rho}^\top x+b_{k,\rho}$（$k=1,2$），比较 $(w_{1,\rho},b_{1,\rho})\stackrel{?}{=}(w_{2,\rho},b_{2,\rho})$。
**证明思路**　细分后最优项在区内固定；若存在不等，则在该区解 LP/SOCP 可直接给反例点。□
**复杂度**　可判定；最坏指数（细分规模）。

### SWT‑4（差异区域自动机）

**陈述**　可构造识别 $\{x:\ |F_1(x)-F_2(x)|>\epsilon\}$ 的自动机。
**构造**　令 $g=F_1-F_2$；在共同细分上添加 $\{g\ge \epsilon\}$ 与 $\{-g\ge \epsilon\}$ 守卫，取并。
**性质**　输出为差异区域的多面体复形，可直接产出反例点（解一次 LP）。□

### SWT‑5（最小实现复杂度）

**陈述**　固定**有限**守卫库 $\mathcal H$（H‑形式）与**有限**仿射权基 $\mathcal B$。若 $F$ 可由 $(\mathcal H,\mathcal B)$ 表示，定义

$$
\mathrm{MC_g}(F;\mathcal H,\mathcal B)=\min\{|\mathrm{guards}(A)|:\ A\ \text{为无环 SWT},\ \mathrm{guards}(A)\subseteq\mathcal H,\ \mathrm{weights}(A)\subseteq\mathcal B,\ A\equiv F\}.
$$

则该最小值**存在**；判定 $\mathrm{MC_g}(F;\mathcal H,\mathcal B)\le k$ 一般 **NP‑难**（由 Set‑Cover 多项式规约）。若 $F$ 不可由 $(\mathcal H,\mathcal B)$ 表示，则 $\mathrm{MC_g}=+\infty$。

**证明思路（规约要点）**　由 **Set‑Cover** 多项式规约：以必须区分的输入子域族为“元素”，候选守卫为“子集”，“最少守卫覆盖所有子域”⇔“存在代价≤$k$ 的 SWT 实现 $F$”；故问题 NP‑难。存在性由可编译性（规模有界）推得在 $\mathbb N$ 上取最小。

------

# 5　函数几何与可微结构

> 记 $F:\mathcal D_{\mathrm{in}}\!\subseteq\!\mathbb R^n\to\mathbb R^m$ 为由 §4 编译得到的无环 SWT $A_F$ 所表示的 CPWL 函数；标量情形用 $F:\mathbb R^n\to\mathbb R$ 表示。以下结论均在 A1–A6 与 $K_f$ 权重域下成立。

## GEO‑1　线性区域的显式构造

**目标**　提取有限集合 $\{(R_\rho,w_\rho,b_\rho)\}_\rho$，使得

$$
\mathcal D_{\mathrm{in}}=\bigcup_\rho R_\rho,\quad
x\in R_\rho\Rightarrow F(x)=w_\rho^\top x+b_\rho,
$$

且各 $R_\rho$ 为 H‑形式多面体，除边界外两两不交。

**算法（构造性）**

1. **候选生成**：对 $A_F$ 进行自顶向下懒惰 DFS/BFS，沿路径 $\pi$ 累积
   守卫 $G(\pi)=\bigcap_{e\in\pi}\! \mathsf G(e)$，仿射 $f_\pi(x)=\sum_{e\in\pi}(w_e^\top x+b_e)+c$。
2. **可行性筛查**：若 $G(\pi)=\varnothing$（LP 不可行）则剪枝。
3. **去劣（支配判定）**：对候选 $\pi,\pi'$，在 $G(\pi)\cap G(\pi')$ 上解

$$
\max_{x}\ [f_\pi(x)-f_{\pi'}(x)]\quad \text{s.t. } x\in G(\pi)\cap G(\pi').
$$

若最优值$\le0$，则 $\pi$ 在该交域上不可能成为最大，可据此切除；完全被切除则丢弃 $\pi$。
4\) **活跃域构造**：

$$
R_\pi \;=\; G(\pi)\ \cap\ \bigcap_{\pi'\neq\pi}\{\,f_\pi(x)\ge f_{\pi'}(x)\,\}.
$$

若 $R_\pi\neq\varnothing$ 则记对应仿射为 $(w_\pi,b_\pi)$。
5\) **合并与规范化**：对仿射参数相同且并集仍为多面体的 $R$ 做合并；守卫 H‑形式去冗余、行归一化。

**证明思路（正确性）**

* *有限性*：无环 SWT 的边/比较守卫有限 ⇒ 候选与比较面有限。
* *覆盖性*：对任意 $x$，至多有限条可行路径；$\oplus$ 最大项对应某候选 $\pi$，且 $x\in R_\pi$。
* *唯一性（几乎处处）*：若 $x\in \operatorname{relint}(R_\pi)$ 则 $f_\pi>f_{\pi'}$（对所有 $\pi'\ne\pi$），仿射唯一；tie 仅发生在边界（测度零）。

**复杂度**　最坏指数（门控数）；每次可行性/支配判定为 LP。
**稳定性**　比较采用阈值 $\tau$ 处理数值 tie；空域即时剪枝；懒惰扩展减少候选爆炸。

## GEO‑2　值域的精确极值计算

**陈述**　令 $\{(R_\rho,w_\rho,b_\rho)\}$ 为 GEO‑1 输出。对任意凸域 $\mathcal D\subseteq \mathbb R^n$，有

$$
\max_{x\in\mathcal D}F(x)=\max_{\rho}\ \max_{x\in \mathcal D\cap R_\rho}\ (w_\rho^\top x+b_\rho),
\quad
\min_{x\in\mathcal D}F(x)=\min_{\rho}\ \min_{x\in \mathcal D\cap R_\rho}\ (w_\rho^\top x+b_\rho).
$$

内层为仿射在凸集上的最优化，具体化如下：

| $\mathcal D$                                    | 约束形式                                                     | 复杂度     |
| ----------------------------------------------- | ------------------------------------------------------------ | ---------- |
| 多面体/盒                                       | LP                                                           | 多项式时间 |
| $\ell_\infty$ 球 $ \|x-x_0\|_\infty\le\epsilon$ | LP（引入盒变量）                                             | 多项式     |
| $\ell_1$ 球 $ \|x-x_0\|_1\le\epsilon$           | LP（拆符号/引入辅助变量）                                    | 多项式     |
| $\ell_2$ 球 $ \|x-x_0\|_2\le\epsilon$           | **闭式**：$\max = w^\top x_0+b+\epsilon\|w\|_2$；交多面体时为 SOCP | 多项式     |

**证明思路**　区域内为仿射；仿射在凸集上的极值出现在极点/受控方向，$\ell_2$ 球用 Cauchy–Schwarz 得闭式；全局取区域最大/最小即得。

**工程**　优先用 $\|w_\rho\|_{p^*}$ 给上界剪枝；以优先队列遍历“潜在大值”的区域。

## GEO‑3　决策边界复形

**陈述**　对分类分量 $i\ne j$，令差分 $g=F_i-F_j$。其零水平集

$$
DB_{ij}=\{x:\ g(x)=0\}
$$

是有限多面复形；每片段由 $(R_\rho,\ w_\rho^\top x + b_\rho=0)$ 给出。

**证明思路**　在每个 $R_\rho$ 上 $g$ 为仿射，零集与多面体交为多面体片；有限并形成复形。边界法向为 $w_\rho/\|w_\rho\|_2$；点到边界距离为 $|w_\rho^\top x+b_\rho|/\|w_\rho\|_2$。

## GEO‑4　梯度/雅可比自动机

**陈述**　存在与 $A_F$ 同步的变换器 $T_{\nabla F}$，在 a.e. 处输出精确 $\nabla F$（或 $J_F$）；在不可微点返回 Clarke 次微分的代表（如最小范数元）。

**构造**　对每个 $(R_\rho,w_\rho,b_\rho)$ 建立“发射片段”，权为常向量 $w_\rho$（或矩阵 $J_\rho$），守卫为 $R_\rho$；tie 处可返回 $\operatorname{co}\{w_{\rho_k}\}$ 的代表（求最小范数解的 QP）。

**证明思路**　CPWL 在各区域仿射 ⇒ 区内梯度常值；不可微点的 Clarke 次微分为相邻梯度凸包。构造即语义。
**代价**　与区域数同阶；雅可比可按块稀疏存储（卷积/GNN）。

## GEO‑5　全局/局部 Lipschitz 的精确值

**结论**　标量：$\displaystyle L_p(F)=\max_\rho |w_\rho|_{p^*}$；向量（输入 $\ell_p$、输出 $\ell_r$）：$\displaystyle L_{p\to r}(F)=\max_\rho |J_\rho|_{p\to r}$。

**求解器注记**　$p=r=2$：谱范数（幂迭代）；在 $p,r\in{1,2,\infty}$ 中，闭式/易解：$1!\to!1,\ \infty!\to!\infty$（列/行和），$1!\to!\infty$（最大绝对元），$2!\to!\infty/1!\to!2$（最大行/列 $\ell_2$ 范）；**NP‑难**：$\infty!\to!1,\ \infty!\to!2,\ 2!\to!1$（通常用松弛/近似或上界）；一般 $p,r$：用 $p$‑范数/幂锥的锥规划求**上界**或数值近似。

**局部/域内**　将最大化限制到 ${\rho:\ R_\rho\cap\mathcal D\neq\varnothing}$ 即得局部（或域内）常数。

---

# 6　可判定应用：验证、等变与因果/修复

## 6.1　性质规格与产品构造（VER‑1）

**性质语言（原子）**

* 输入域约束：$x\in\mathcal D$（盒/多面体/$\ell_p$ 球）；
* 输出阈值/区间：$F_k(x)\le u,\ F_k(x)\ge \ell$；
* 分类正确/裕度：$\arg\max_i F_i(x)=y$ ⇔ $\bigwedge_{j\ne y}F_y-F_j\ge 0$；或 $F_y-\max_{j\ne y}F_j\ge \gamma$；
* 关系型：$|F(x)-F(x')|\le\epsilon$ 等。

**构造**　将“反例条件”编为**反例自动机** $A_{\neg\phi}$（差分与阈值写成线性不等式/比较守卫），并与 $A_F$ 复合：$A_{cex}=A_F\circ A_{\neg\phi}$。

**判定**　若 $A_{cex}$ **空**（从初态到终态无可行路径/区域），则 $\forall x\in\mathcal D$ 满足 $\phi$；否则从任一路径解 LP/SOCP 给出反例点。
**证明思路**　复合后每条路径的可行性是线性/二阶锥可行性；空性⇔不存在满足所有守卫的 $x$。
**复杂度**　可判定；最坏指数（路径/细分）；每次可行性为 LP/SOCP。

## 6.2　鲁棒性认证（VER‑2）

**问题**　给定 $x_0,\epsilon,p$ 与标签 $y$，判定 $B_p(x_0,\epsilon)$ 内是否保持分类 $y$（或裕度 $\ge\gamma$）。

**方法 A：分区精确法（构造性，精确）**

* 令 $g(x)=F_y(x)-\max_{j\ne y}F_j(x)$。按 **GEO‑1** 对 $A_F$ 与“赢家类”比较面做**共同细分**，使每个子域 $R$ 上 $g(x)=w^\top x+b$ 为**单仿射**。
* 对每个 $R$ 解凸问题 $\min_{x\in R\cap B_p(x_0,\epsilon)} g(x)$：

     $p\in\{1,\infty\}\Rightarrow$ **LP**；$p=2\Rightarrow$ **SOCP**；**无需整数变量/MIQP**（仅在**未细分**且含门控时需 MIP 编码）。

- 汇总各域最小值取全局最小 $g_{\min}$。若 $g_{\min}\ge\gamma$（$\gamma=0$ 表示分类不变）则认证通过；否则返回达到最小值的 $x$ 作为反例。

**方法 B：混合整数一体化（适合 $p\in\{1,\infty\}$/盒域）**

* 把 ReLU/Max 精确编码为**指示约束**或紧 big‑M；
* 目标 $\min g(x)$ 或 $\min\|x-x_0\|_p\ \text{s.t. }g(x)\le0$；
* 得到**可验证全局最优**的反例或认证。

**数值要点**　big‑M 取值由区间传播得紧界；优先用指示约束避免松弛；tie 采用阈值 $\tau$。

## 6.3　等变验证（VER‑3）

**设定**　给输入变换 $g:\mathcal D_{\mathrm{in}}\to\mathcal D_{\mathrm{in}}$ 与输出变换 $g':\mathbb R^m\to\mathbb R^m$（如 CNN 平移、GNN 置换）。将二者编为 SWT：$\mathcal T_g,\mathcal T_{g'}$。

**目标**　判定

$$
A_F\circ \mathcal T_g \;\equiv\; \mathcal T_{g'}\circ A_F .
$$

**方法**　两侧皆为无环 SWT，应用 **SWT‑3**：构造共同细分并在每个子域比对仿射参数。
**边界与有效域**　卷积的 padding/stride 造成边界/采样效应；在**有效子域**（不受边界影响或与 stride 对齐的子格）上更可能成立，其余子域差异由差异自动机定位。
**输出**　等价证书或差异区域（含误差上界与见证点）。

## 6.4　干预与反事实（CAU‑1 / CAU‑2）

### CAU‑1（干预保持 CPWL）

**陈述**　将中间子表达式（节点/通道/共享维）替换为任意 CPWL $P_c$ 后，所得 $F_C$ 仍为 CPWL；差分 $g_C=F-F_C$ 亦为 CPWL。
**证明思路**　DAG 内子图替换不引环；组合仅涉及仿射与 $\max$ ⇒ CPWL 闭包；差分为 CPWL 函数之差，仍 CPWL。

### CAU‑2（最大因果影响）

**目标**　$\displaystyle I_{\max}(C;\mathcal D)=\sup_{x\in\mathcal D}|F(x)-F_C(x)|$。

**方法**

* **分区法（精确）**：对 $g_C$ 的区域细分 $\{\tilde R\}$，在每个 $\tilde R$ 解
  $\max_{x\in \tilde R\cap\mathcal D} |w^\top x+b|$（等价于两次仿射最大化）；取全局最大。
* **MIP 法**：变量 $t$ 使 $t\ge g_C(x),\ t\ge -g_C(x)$，最大化 $t$ 并编码门控与域约束。

**输出**　精确数值 $I_{\max}$ 与实现点；可逐分量给出影响谱。

## 6.5　参数/结构修复与综合（SYN‑1 … SYN‑3）

### SYN‑1（参数修复）

**问题**　$\min_{\Delta W}\ \|\Delta W\|_p
\quad\text{s.t.}\quad
A_{W+\Delta W}\models \Phi .$

**解法（CEGIS，构造性）**

1. 给定 $\Delta W$ 候选，调用 VER‑1 验证；若通过则返回。
2. 若失败，抽取**反例区域/点** $\{\mathcal R_k\}$（及不可行证书若可得）。
3. 在仅约束 $\{\mathcal R_k\}$ 的近似等式/不等式上更新 $\Delta W$（解凸子问题或 MIP 子问题）。
4. 迭代，直至验证通过或获得不可行证书（或触发预设终止条件）。

**保证**　流程**健全但不完备**：若终止于解则满足 $\Phi$；**仅当**验证/子问题产生**不可行证书**时才报告不可行；否则可能不终止。对**线性规格/凸参数化**等特例可保证终止；可结合**罚项同伦**作可行热启动。

### SYN‑2（由规范直接综合）

**问题**　$\min_W\ \|W\|_p\quad\text{s.t.}\quad A_{F_W}\models \Phi .$

**策略**

* **两阶段**：先施加**充分条件**（如层范数乘积 $\prod_l\|W_l\|_{p\to p}\le L_0$，$p=2$ 可用谱范数/SDP/谱归一化）获得可行上界；再在**有限活跃区域**上用 VER‑3 与 LP/SOCP **加切细化**（必要时仅在选定子域检验精确条件 $\|J_\rho(W)\|_{p\to r}\le L_0$）。
* **等变性**：对任意 $g$，用 $A_{F_W}\!\circ\!\mathcal T_g\equiv\mathcal T_{g'}\!\circ\!A_{F_W}$ 的**差异切面**驱动 CEGIS 迭代消缺。

**性质**　返回解则满足 $\Phi$；不保证**全局最优/完备**。

### SYN‑3（最短结构编辑）

**问题**　在**有限**原子算子集 $\mathcal O$（增/删层、Max↔Avg、改 stride/padding、剪枝等）上求最短编辑序列 $S$，使 $A_{S(F)}\models\Phi$；并给定**组合闭包/容量**约束（位置与步数上限）。

**方法 A（A\*）**　状态：当前模型；动作：$o\in\mathcal O$；代价：单位/加权步长。若在由上述上限界定的**有限搜索图**上，启发 $h$**可采纳且一致**（如由 **CAU‑2 的**可达误差上界**构造），则保证**全局最短；否则为启发式近似。

**方法 B（MILP）**　在**预先枚举的有限候选编辑集**上引入二值 $z_i$，目标 $\min\sum z_i$；用指示/凸包约束编码“是否应用”与语义耦合；在该有限域上得到**全局最优**。

------

## 7.1 共同设置

**环境与实现**

* 语言与库：Python 3.10+；PyTorch / JAX（二选一）；CVXOPT 或 Gurobi/CPLEX（LP/SOCP/MIP 任一可用）；自写 SWT 编译器（按 §4.1）。
* 浮点与阈值：FP32；**tie/相等阈值** $\tau=10^{-7}$；guard 归一化后 $\|A_i\|_2=1$。
* big‑M/指示约束：优先用**指示约束**；必须用 big‑M 时，$[l,u]$ 由区间传播获得，设置 $M=\max(|l|,|u|)$。
* 随机性：固定 `seed=2025`（numpy/torch/random）。
* 报告单位：时间（秒），规模（#states、#guards 等）。

**统一评测接口**

* `Compile(F) → A_F`（返回 #states、#edges、#guards、编译时间）。
* `ForwardEq(F, A_F; X)`: 检查 $\max_{x\in X} |F(x)-A_F(x)| \le \tau$。
* `Equiv(A1,A2)`: SWT‑3 等价判定；`Diff(A1,A2,ε)`：SWT‑4 差异区域。
* `Regions(A_F)`: GEO‑1 区域表；`Lipschitz(A_F,p→r,D)`: GEO‑5 精确值。
* `Verify(A_F,φ)`: VER‑1/2/3（空性证书/反例点/反例域）。
* `Intervene(A_F,C) → A_{F_C}` 与 `Imax(A_F,A_{F_C},D)`: CAU‑1/2。

## 7.2 任务一：FFN（UCI 小网络）

**目的**

1. 证明 `Compile` 的**无损性**（数值一致）。
2. 提取**线性区域**与**Lipschitz 精确值**并与层范数上界对照。
3. 小域**鲁棒性**精确认证。

**数据**

* UCI Iris（三分类，4 维特征；标准化到零均值单位方差）。
* 划分：随机 70%/15%/15%（train/val/test）。

**模型 $F_{\text{FFN}}$**

* 结构：`Linear(4→16) → ReLU → Linear(16→16) → ReLU → Linear(16→3)`。
* 训练：交叉熵，Adam(lr=1e-3)，epochs=100，batch=32，选择 val 最优。

**输入域与度量**

* $\mathcal D_{\text{in}} = \prod_{k=1}^{4} [\mu_k-3\sigma_k,\ \mu_k+3\sigma_k]$（按训练集统计）。
* 前向一致性集 $X$：从 $\mathcal D_{\text{in}}$ 中均匀采样 1,000 点。
* Lipschitz：计算 $L_{2\to 2}^{\text{exact}}$（GEO‑5），对照层范数上界 $ \prod_l \|W_l\|_{2\to2}$。

**流程**

1. 训练 $F_{\text{FFN}}$（仅保证可用精度）。
2. `A_F = Compile(F)`；记录 #states/#guards/编译时间。
3. `ForwardEq(F,A_F; X)`：应**全通过**（≤$\tau$）。
4. `R = Regions(A_F)`：记录区域数（可在 $\mathcal D_{\text{in}}$ 内可达区域数）。
5. `Lipschitz(A_F, 2→2, D_in)`：得 $L^{\text{exact}}$；计算 $L^{\text{upper}}=\prod_l \|W_l\|_2$（谱范数，用幂迭代）；报告二者比值。
6. **鲁棒性认证**（VER‑2）：对 10 个随机测试样本 $x_0$，半径 $\epsilon \in \{0.1,0.2\}$（$\ell_2$ 球），认证 `margin ≥ 0`。报告**认证通过率**与**最小反例**（若失败）。

**验收标准**

* 一致性：$\max_{x\in X}\|F(x)-A_F(x)\|_\infty \le 10^{-7}$。
* GEO‑5：给出非平凡 $L^{\text{exact}}$，且 $L^{\text{exact}} \le L^{\text{upper}}$。
* VER‑2：输出“通过/反例点”；若有反例，给出最小 $\|x-x_0\|_2$。

**报告表格 A（FFN）**

| metric                                                  | value |
| ------------------------------------------------------- | ----- |
| compile time (s)                                        |       |
| #states / #guards                                       |       |
| #reachable regions (in $D_{\text{in}}$)                 |       |
| forward max‑err on 1k                                   |       |
| $L_{2\to2}^{\text{exact}}$ / $L_{2\to2}^{\text{upper}}$ |       |
| robustness pass rate @ $\epsilon=0.1/0.2$               |       |

## 7.3 任务二：轻量 CNN（CIFAR‑10 子集）

**目的**

1. 验证**平移等变**在**有效域**上成立。
2. 用差异自动机定位**边界破坏**。

**数据**

* CIFAR‑10 的**小子集**：每类 1,000 张（共 10,000 / 2,000 train/test），像素 $[0,1]$ 归一化。

**模型 $F_{\text{CNN}}$**

* 结构 A（等变友好，stride=1）：
  `Conv3x3(3→16,s=1,p=1) → ReLU → Conv3x3(16→32,s=1,p=1) → ReLU → GlobalAvgPool → Linear(32→10)`。
* 训练：交叉熵，Adam(lr=1e-3)，epochs=20，batch=128。

**平移变换与有效域**

* 平移集合 $\mathcal S=\{(\Delta x,\Delta y):\Delta x,\Delta y\in\{-2,-1,0,1,2\}\}$。
* **有效域**掩膜 $M_{\Delta}$：对每个平移，去除因 padding 影响的**2 像素边框**（对 s=1,p=1）。

**验证流程**

1. 训练并 `A_F = Compile(F)`；记录规模/时间。
2. 对 100 张随机测试图像 $x$：

   * 构造 `shift(x,Δ)`（零填充后裁剪至原尺寸）。
   * 计算 `y1 = A_F(x)` 与 `y2 = A_F(shift(x,Δ))`；
   * 同时计算 `shift_out = shift_output(y1,Δ)`（对 GlobalAvgPool 之后的**类别分量**，等变为**恒等**；若在中间层验证，可在卷积特征层进行索引平移）。
   * 判定：在**有效域定义的输出层**（全局池化后，无空间维），期望 $y2 = y1$；即分类 logits 完全一致。
3. 统计**等价通过率**（所有 Δ 的一致率），并对失败样本调用 `Diff(A_F, T_{g'}∘A_F∘T_g^{-1}, ε=1e-7)` 生成**差异区域**，报告**边界相关守卫**（定位到 padding 处）。

**可选对照（破坏等变）**

* 结构 B（含 stride=2 的下采样）：
  `Conv3x3(3→16,s=2,p=1) → ReLU → Conv3x3(16→32,s=1,p=1) → ReLU → GlobalAvgPool → Linear`。
* 只在**子格平移**（Δ 为偶数）上检验；其余 Δ 预期不等价。差异自动机应主要落在**采样别名**守卫上。

**验收标准**

* 结构 A：等变通过率 ≥ 95%（个别失败仅来自数值误差/极少数边界样本）。
* 结构 B：偶数平移通过率高，奇数平移显著失败；差异守卫集中在 stride/padding 引入的边界区域。

**报告表格 B（CNN）**

| metric                                  | value |
| --------------------------------------- | ----- |
| compile time (s)                        |       |
| #states / #guards                       |       |
| equivariance pass rate (A, all Δ)       |       |
| pass rate (B, even Δ / odd Δ)           |       |
| #diff‑regions linked to boundary/stride |       |

**说明**

* 输出层（GlobalAvgPool 后）等变应表现为**输出不变**（而非空间平移），与 §10 的 $g'=\text{id}$ 一致。若在中间层检查，需用相同 Δ 对特征图索引平移比对。

## 7.4 任务三：固定图 GNN（Zachary Karate）

**目的**

1. 验证**置换等变**（VER‑3）。
2. 做一次**共享维度干预**并计算 $I_{\max}$（CAU‑2）。

**数据与图**

* Zachary Karate Club 图，$|V|=34, |E|=78$。
* 节点特征：度（degree）、聚类系数、谱嵌入前 4 维（共 $d=6$）；标签为 2 社团（用于训练，非关键）。

**模型 $F_{\text{GNN}}$**

* `GCNConv(d→16) → ReLU → GCNConv(16→16) → ReLU → Linear(16→2)`；
* Sum/Mean 聚合任选其一（保持对称）；训练 epochs=200，Adam(lr=1e-2)。

**置换等变验证**

1. 训练并 `A_F = Compile(F)`；
2. 采样 50 个随机**节点置换** $\pi$（打乱索引，邻接随之重排）；构造 $\mathcal T_\pi$ 与输出置换 $\mathcal T_{\pi}'$（对节点次序重排）。
3. 调用 `Equiv(A_F∘T_π, T_π'∘A_F)`：记录**通过率**与最早出现差异的层（若有）。

**干预与最大因果影响**

* 干预 $C$：将第二层激活的第 $k^\star$ 个**共享维度**（选 $k^\star$ 使其方差最大）置零：$\texttt{do}(h^{(2)}_{v,k^\star}\leftarrow 0,\ \forall v)$。
* 令 $A_{F_C} = \text{Intervene}(A_F,C)$。
* 定义输入域 $\mathcal D = \{\mathbf X:\ \|\mathbf X- \mathbf X_0\|_\infty \le 0.1\}$（$\mathbf X_0$ 为图特征矩阵）。
* 计算 `Imax(A_F,A_{F_C}, D)`（CAU‑2，分区法或 MIP），并报告达到上界的**图节点/模式**。

**验收标准**

* 置换等变：通过率 ≥ 100%（在**无边界效应**的固定图上应严格成立）；若失败，应由 `Diff` 给出责任守卫（通常来自实现错误）。
* $I_{\max}$：给出非零的最大影响值及其见证输入（可报告受影响最大的节点索引与类别 margin 变化）。

**报告表格 C（GNN）**

| metric                                        | value |
| --------------------------------------------- | ----- |
| compile time (s)                              |       |
| #states / #guards                             |       |
| permutation equivariance pass rate (50 perms) |       |
| $I_{\max}$ (value) / arg‑max node(s)          |       |

## 7.5 结果呈现与版面建议（1–2 页）

**表 1（FFN）**：A 表。
**表 2（CNN）**：B 表（结构 A 与 B 并列）。
**表 3（GNN）**：C 表。
**图 1（可选）**：FFN 在二维 PCA 切片上的**决策边界复形**（GEO‑3）。
**图 2（可选）**：CNN 的**差异热图**（边界区域显著）。







深刻理解吃透这一份研究，然后做三件事 
1. 逐一验证每个引理和定理是否都成立(并在每处标明“✅成立 / ⚠️需补强 / ❗潜在问题”) 
2. 最后以一个ICLR审稿人的角度，给整个研究审稿+评分，满分100