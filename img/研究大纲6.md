# Part I. 基础与范围

---

## **第 1 章  引言与贡献地图**

### 1.1 研究动机：从 CPWL 到“符号爆炸 → 自动机共享”

**事实 A（CPWL 本质）**
由仿射层（全连接/卷积/均值池化/推理态 BN/加法残差）与 ReLU/Leaky‑ReLU/PReLU/MaxPool 组成的**有向无环**网络（含固定图上的 GNN），其**输入→输出**映射是一个**连续分段线性（CPWL）**函数。CPWL 的核心特征是：输入空间被若干由线性不等式描述的**凸多面体**划分，每个区域内函数均为**同一个仿射式**。

**痛点 B（符号爆炸）**
若直接用“符号树”表达 CPWL——层与层的 $\max$/$+$/仿射复合，会产生**指数级重复子式**：大量线性片段与门控条件在树中被重复枚举，难以存储与求解。

**愿景 C（共享结构）**
如果能把“重复子式”改写为**可共享的图结构**（DAG），使得相同子表达式只存一次，既能**无损**表示 CPWL，又能在其上做**几何/验证/因果**等运算，即可消解“符号爆炸”。\*\*符号加权自动机/变换器（SWA/SWT）\*\*正提供了这样的共享载体（在第 II 部分正式引入）。

### 1.2 问题陈述：统一、等价、可判定、可工程

1. **统一表示**：建立一个覆盖 FFN/CNN/固定图 GNN 的**层演算**与**自动机表示**的统一框架；
2. **等价编译**：把网络函数 $F$ 的 CPWL 表达**等价**编译成**带多面体守卫**的符号加权变换器 $A_F$；
3. **可判定分析**：在 $A_F$ 上实现**几何解析**（区域/梯度/Lipschitz/边界）与**形式化验证**（鲁棒/对称/等变/等价）；
4. **因果与修复**：把中间激活/滤波器/共享维度的**干预**与**修复/综合**转化为**可构造**的优化/判定问题。

### 1.3 核心贡献

1. **统一 CPWL 代数**：提出“预激活空间 $\mathcal P$ + 激活半环 $S_+$ + 投影 $\sigma$”的**层演算总则**（AF‑1…AF‑5），对 FFN/CNN/GNN **一体化**建模。
2. **SWT 编译**：给出**可实现**的层到变换器编译流程（第 5 章），并证明**语义等价**（SWT‑1），规模与无环性上界（SWT‑2）。
3. **几何精确分析**：从 $A_F$ **确定性**抽取线性区域、梯度/雅可比、决策边界复形、全局/局部 Lipschitz（GEO‑1…GEO‑5）。
4. **可判定验证**：把鲁棒性、属性满足、等变性、模型等价等转化为**自动机合成/空性/等价**问题（VER‑1…VER‑3, SWT‑3, SWT‑4）。
5. **因果/修复**：定义干预‑反事实的 CPWL 闭包与最大效应精确量化（CAU‑1…CAU‑2），以及参数/结构修复与综合的形式化构建（SYN‑1…SYN‑3）。

---

## **第 2 章  适用边界、假设与记号**

### 2.1 适用/不适用组件表

| 类别 | **完全适用（精确）**                            | **不适用 / 需近似（本书不主讲）**             |
| ---- | ----------------------------------------------- | --------------------------------------------- |
| 激活 | ReLU / Leaky‑ReLU / PReLU / 绝对值 / 恒等       | Sigmoid / Tanh / GELU / Swish / Softmax / ELU |
| 线性 | 全连接、卷积、加法残差、**推理态** BN、均值池化 | 训练态 BN（均值/方差随批变化）                |
| 聚合 | 和/均值/最大（GNN、池化）                       | 乘法门（LSTM/GRU）、自注意力                  |
| 结构 | **DAG**（含固定图的 GNN）                       | 循环结构（RNN）、动态图                       |
| 随机 | —                                               | Dropout 等随机层                              |

> **备注**：GNN 需**图拓扑固定**且消息传递可展为 DAG。

### 2.2 统一假设（Assumption Box）

* **A1（DAG）**：计算图无环；
* **A2（CPWL 组件）**：仅由仿射与 ReLU/Max 类门控组成；
* **A3（固定图）**：若为 GNN，图 $G=(V,E)$ 固定不随输入变；
* **A4（推理态 BN）**：均值/方差使用冻结统计量；
* **A5（数值域）**：权重/偏置/归一化参数皆为实数；
* **A6（输入域）**：默认 $\mathcal D_{\text{in}}\subseteq\mathbb R^n$（可为盒/多面体/$\ell_p$ 球等）。

**本书在 A1–A6 下给出“等价‑可判定‑可构造”的结论**；超出边界的模块将被近似或留作未来工作。

### 2.3 输入结构与索引

* **向量型**：$\mathbf x\in\mathbb R^n$。
* **网格型（图像）**：$\mathbf x\in\mathbb R^{C\times H\times W}$，卷积/池化带位置索引。
* **图型（固定图）**：节点特征 $\mathbf X\in\mathbb R^{|V|\times d}$，邻接 $A$ 固定。

### 2.4 记号与范数

* $\|\cdot\|_p$：$\ell_p$ 范数；$p^\ast$ 为对偶范数指数，$1/p+1/p^\ast=1$。
* CPWL：连续分段线性；区域用 $R_\rho$ 表示，仿射参数 $(\mathbf w_\rho,b_\rho)$。
* $\max$ 与 $+$ 常在**按点**意义下使用（函数到函数）。

### 2.5 几何对象与复杂度度量

* **多面体**：$\{x: Cx\le d\}$；**复形**：若干多面体的有限并，交按面相容。
* **复杂度标签**：

  * **构造性（Constructive）**：给出确定性算法；
  * **可判定（Decidable）**：存在判定算法，可能昂贵；
  * **规模（Size）**：以层数、通道数、核尺寸、图度等计；
  * **难度（Hardness）**：NP‑难/MILP/量词消去（双指数）等提示。

---

## **第 3 章  代数预备与层演算总则**

### 3.1 预激活空间 $\mathcal P$：CPWL 的线性闭包

**定义 3.1（$\mathcal P$）**
$$
\mathcal P\ \triangleq\ \{f:\mathbb R^n\to\mathbb R\mid f\ \text{是 CPWL 函数}\}.
$$

令函数加法与标量乘法为按点运算，则 $(\mathcal P,+,\cdot)$ 构成实向量空间（对加法与实数标量乘法闭包）。

**性质**

* 仿射函数属于 $\mathcal P$；
* CPWL 在加法、标量乘法下闭包；
* 卷积/均值池化/加法残差/推理态 BN 都是**线性/仿射**映射，因而在 $\mathcal P$ 内封闭。

### 3.2 激活半环 $S_+$：按点 $\oplus=\max,\ \otimes=+$

为与门控 $\max$ 精确对齐，定义**函数半环**（按点运算）：

**定义 3.2（$S_+$）**
$$
S_+\ \triangleq\ \bigl\{f:\mathbb R^n\to\mathbb R\cup\{-\infty\}\ \big|\ f\ \text{为 CPWL，且} \ f(x)\ge 0\ \text{或} \ f\equiv -\infty\bigr\},
$$

配以按点运算

$$
(f\oplus g)(x)=\max\{f(x),g(x)\},\qquad (f\otimes g)(x)=f(x)+g(x),
$$

加法幺元 $\mathbf 0(x)\equiv -\infty$，乘法幺元 $\mathbf 1(x)\equiv 0$。

> 说明：$\mathbf 0$ 用**常值 $-\infty$** 函数；$\mathbf 1$ 用**常值 0** 函数。这样 $S_+$ 与**热带半环**在**按点层面**兼容，但它是一个**函数半环**而非标量半环。

**命题 3.3**  $(S_+,\oplus,\otimes,\mathbf 0,\mathbf 1)$ 构成交换半环；若 $f,g\in S_+$ 且非常 $-\infty$，则 $f,g$ 为非负 CPWL，$\oplus,\otimes$ 下闭包成立。

### 3.3 投影 $\sigma:\mathcal P\to S_+$（ReLU/Max 的统一视角）

**定义 3.4（ReLU 投影）**
$$
\sigma_{\text{ReLU}}(f)\ =\ \max(0,f)\ \in S_+.
$$

**定义 3.5（N 元 Max 投影）**
$$
\sigma_{\max}(f_1,\dots,f_N)\ =\ \max\{f_1,\dots,f_N\}\ \in S_+.
$$

这些投影把**任意 CPWL**映为**非负 CPWL**（或 $-\infty$）。

### 3.4 **AF‑1（良定义性）**：层演算闭包

**定理 AF‑1（良定义性，FFN/CNN/GNN）**
满足 A1–A6 的网络中，每一层的预激活与激活满足：

1. 预激活由前一层激活的**线性/仿射**组合给出，故位于 $\mathcal P$；
2. 激活由投影 $\sigma$ 施加在预激活上，故位于 $S_+$；
3. 对 CNN 的卷积/均值池化、GNN 的 Sum/Mean/Max 聚合、以及残差/推理态 BN，上述结论逐点成立。

### 3.5 **AF‑2（求值同态）**：与数值网络一致

**定义 3.6（求值映射）**
对固定输入 $\mathbf x_0$，定义
$$
h_{\mathbf x_0}:\ S_+\to\mathbb R\cup\{-\infty\},\quad h_{\mathbf x_0}(f)\ =\ f(\mathbf x_0).
$$

**命题 3.7（半环同态）**
按点定义下，$h_{\mathbf x_0}$ 满足
$$
h_{\mathbf x_0}(f\oplus g)=\max\{h_{\mathbf x_0}(f),h_{\mathbf x_0}(g)\},\quad
h_{\mathbf x_0}(f\otimes g)=h_{\mathbf x_0}(f)+h_{\mathbf x_0}(g).
$$

**定理 AF‑2（同态求值）**
令 $P(\mathbf y)\in S_+$ 为网络输出的层演算表达，则
$$
h_{\mathbf x_0}\bigl(P(\mathbf y)\bigr)\ =\ F(\mathbf x_0),
$$

即符号表达与数值前向计算**逐点一致**。

### 3.6 **AF‑3（结构性质）**：CPWL / 连续性 / 条件凸性

**定理 AF‑3（结构性质）**
在 A1–A6 下：

1. **CPWL 与连续性**：任意标量输出 $y$ 的 $P(y)$ 为 CPWL，因而连续；向量输出按分量成立。
2. **（充分）凸性**：若对每一层，**连接到上一层激活的线性组合系数均非负**，则 $P(y)$（及其分量）为凸函数。

**说明**

* 凸性的“非负权”是**充分而非必要**条件；例如首层仿射可含负权，但 ReLU 后仍凸。
* CNN/GNN 在**逐点**意义下同理（位置/节点索引展开）。

### 3.7 **AF‑4（几乎处处可微）**：分段常数梯度/雅可比

**定理 AF‑4**
CPWL 函数在其定义域**几乎处处可微**；对每个线性区域 $R_\rho$，存在常向量 $\mathbf w_\rho$（或雅可比 $J_\rho$）使得
$$
\forall \mathbf x\in R_\rho,\quad P(y)(\mathbf x)=\mathbf w_\rho^\top \mathbf x+b_\rho,\quad \nabla P(y)(\mathbf x)=\mathbf w_\rho.
$$

在区域边界（测度零集合）上可用 Clarke 次微分描述。

### 3.8 **AF‑5（组合性）**：逐层 CPWL 复合

**定理 AF‑5（分层组合性）**
任一层 $l$ 的激活溯源 $P(a^{(l)})$ 是上一层激活 $P(a^{(l-1)})$ 的**CPWL 复合**：
$$
P(a^{(l)})\ =\ \sigma\bigl( W^{(l)}\cdot P(a^{(l-1)}) + b^{(l)} \bigr),
$$

其中 $\sigma$ 为 ReLU/Max 投影。递归展开得到输出是输入的 CPWL 复合。

---

# **Part II. 符号加权自动机的网络表示**

## **第 4 章  符号加权自动机/变换器（SWA/SWT）**

### 4.1 定义：带多面体守卫的符号加权自动机/变换器

我们首先在**向量输入**（$\mathcal D_{\text{in}}\subseteq\mathbb R^n$）上定义**符号加权自动机**（SWA），随后给出**变换器**（SWT）与对**网格/图结构**的扩展。

**定义 4.1（SWA）**
一个（标量输出的）**符号加权自动机**是七元组
$$
A=(Q,\,q_{\mathrm{init}},\,F,\,E,\,\mathsf{G},\,\mathsf{W},\,K_f)
$$

其中：

* $Q$ 为有限状态集，$q_{\mathrm{init}}\in Q$ 初始状态，$F\subseteq Q$ 终止状态；
* $E\subseteq Q\times Q$ 为有向边（转移）；
* $\mathsf{G}:E\to \mathcal P(\mathbb R^n)$ 为**守卫映射**，每条边 $e$ 关联一个**多面体守卫** $\mathsf{G}(e)=\{x: A_ex\le b_e\}$；
* $K_f=(\text{CPWL}^{\pm \infty},\,\oplus,\,\otimes,\,\mathbf 0,\,\mathbf 1)$ 为**按点热带函数半环**（见 §4.2）；
* $\mathsf{W}:E\cup Q\to K_f$ 为**权重函数**，给出边/状态的**仿射（或 CPWL）权**；对非终止状态，$\mathsf{W}(q)\equiv \mathbf 0$ 可取缺省。

给定输入 $x\in\mathcal D_{\text{in}}$，一条**可行路径** $\pi=e_1e_2\cdots e_T$ 满足 $x\in \bigcap_{t=1}^T \mathsf{G}(e_t)$。其**路径权值**为

$$
\mathsf{val}_A(\pi,x)\ =\ \bigotimes_{t=1}^T \mathsf{W}(e_t)(x)\ \otimes\ \mathsf{W}(q_{\mathrm{init}})(x)\ \otimes\ \mathsf{W}(q_T)(x)
$$

其中 $\otimes$ 为**按点相加**（§4.2）。自动机在 $x$ 处的输出为所有可行路径的 $\oplus$（按点 $\max$）：

$$
A(x)\ =\ \bigoplus_{\pi:\,q_{\mathrm{init}}\!\to\!F,\,x\models \pi}\ \mathsf{val}_A(\pi,x).
$$

**注**：守卫把“在哪个区域启用哪个仿射式”编码为**可行路径条件**；$\oplus$/$\otimes$ 的选择（$\max/+$）与 ReLU/Max 门控的 CPWL 语义一致。

**定义 4.2（SWT：符号加权变换器）**
SWT 作用在**自动机**上，表示“**一层网络**如何把上一层的 CPWL 函数变成下一层的 CPWL 函数”。形式化地，一个从 $m$ 个标量输入函数到 $k$ 个标量输出函数的 SWT，记为
$$
\mathcal T:\ (K_f)^{m}\ \leadsto\ (K_f)^{k},
$$

由一组带守卫的变换**片段**组成，每个片段把输入端的某些仿射片映为输出端仿射片，并与相应守卫**相交**。当 $\mathcal T$ 作用于由上层编译得到的自动机 $A$ 时，得到新自动机 $\mathcal T(A)$。

> 实现上，SWT 可看作“把 **片段表（piece table）** 经守卫裁剪后再合并”的图算子（§5）。

### 4.2 权重域：按点热带函数半环 $K_f$

**定义 4.3（$K_f$）**
$$
K_f=(\text{CPWL}^{\pm\infty},\ \oplus,\ \otimes,\ \mathbf 0,\ \mathbf 1),
$$

其中：

* 元素是 $\mathcal D_{\text{in}}\to \mathbb R\cup\{-\infty\}$ 的 **CPWL** 函数；
* $(f\oplus g)(x)=\max\{f(x),g(x)\}$（按点最大）；
* $(f\otimes g)(x)=f(x)+g(x)$（按点相加）；
* $\mathbf 0(x)\equiv -\infty$, $\mathbf 1(x)\equiv 0$。

**性质 4.4**
$K_f$ 为交换半环；常值仿射函数 $x\mapsto \alpha$ 与线性/仿射函数 $x\mapsto w^\top x+b$ 均在其中。**卷积/均值/残差/推理态 BN** 等仿射算子对应在 $\otimes$ 下的加法聚合；ReLU/Max 对应 $\oplus$ 的选择逻辑，由守卫限制其适用域。

> 直观上：**路径相加（$\otimes$）**聚合“线性贡献”，**路径择优（$\oplus$）**实现“取最大”。守卫确保“哪条路径可行”。

### 4.3 结构化输入：向量/网格/图的字母表与守卫谓词

* **向量**：$\Sigma_{\text{vec}}=\{1,\dots,n\}$ 仅用于索引变量；守卫谓词是 $A x\le b$ 形式的线性不等式。
* **网格（图像）**：$\Sigma_{\text{grid}}=\{(c,i,j)\}$；卷积/池化用**滑窗守卫**表达“当前位置（$i,j$）的局部仿射式”，共享权重通过**参数别名**实现（§5.4）。
* **图（固定 $G=(V,E)$）**：$\Sigma_{\text{graph}}=\{v\in V\}$（或边/有向邻接索引）；Sum/Mean/Max 聚合用**邻域约束**与**聚合守卫**表达（§5.5）。

> 统一看法：结构化输入决定了**转移的复制模式**与**守卫参数化**（如滑窗位置、邻域元素）。

### 4.4 复合/积构造/产出语义

* **复合（Composition）**：$\mathcal T_2\circ \mathcal T_1$ 作用于 $A$ 等价于先行 $A_1=\mathcal T_1(A)$，再行 $A_2=\mathcal T_2(A_1)$。守卫取**交**，权重取 $\otimes$ 聚合，分支取 $\oplus$。
* **积构造（Product）**：对两个自动机 $A,B$，其积 $A\otimes B$ 的状态为笛卡尔积，守卫为**交**，权重为**相加**；$\oplus$ 用于并行最优选择。常用于**差分函数**与**性质合成**（§6.2、§9）。
* **产出**：SWA/SWT 的最终产出是**（守卫，仿射）片段集合**的共享图表示。对任意 $x$，自动机值是满足守卫的路径所对应仿射值的 $\max$。

### 4.5 **SWT‑0（模型对照）**：与经典 WFA 的差异与必要性

* **经典 WFA**：权重是标量（常在 $(\mathbb R,\ +, \times)$ 或热带 $(\mathbb R\cup\{-\infty\},\max,+)$），状态转移按**离散字母**。**不能**直接表达“**多面体守卫**+**仿射函数**”这样的连续条件与值函数。
* **SWA/SWT（本章）**：

  1. **权重是函数**（$K_f$ 中的 CPWL）；
  2. **转移带守卫**（多面体）；
  3. 仍保留 $\oplus/\otimes=\max/+$ 的“热带型”演算。
* **必要性**：一般（**非凸**）CPWL 需要“**不同区域不同仿射式**”。没有守卫的 WFA 只能全局 $\max$-of-affine（适合**凸**情形），对一般 CPWL 不**等价**。因此引入**守卫**是实现**无损编译**的关键。

---

## **第 5 章  从网络到 SWT 的编译器**

> 目标：给出一个**构造性**、**可实现**的逐层编译器，把任意满足 A1–A6 的网络 $F$ 编为等价的 $A_F$。

### 5.1 编译接口：$\mathcal T_l$（层变换器）的规范

对第 $l$ 层，设上一层已编译为自动机 $A_{l-1}$，其输出（标量或张量各分量）由一组**（守卫，仿射）片段**共享表示。**层变换器** $\mathcal T_l$ 接收 $A_{l-1}$，输出 $A_l=\mathcal T_l(A_{l-1})$。

**片段数据结构（实现建议）**

$$
\texttt{Piece} = (\underbrace{C}_{\text{H-形式守卫}},\ \underbrace{\mathbf w}_{\text{线性系数}},\ \underbrace{b}_{\text{常数}})
\quad\text{表示}\quad
\{\ x\in C\ \Rightarrow\ f(x)=\mathbf w^\top x + b\ \}.
$$

自动机是这些片段的**共享 DAG**，边携带守卫与仿射增量，合并路径时以 $\otimes$/$\oplus$ 聚合。

### 5.2 线性层 / 推理态 BN / 残差：仿射权重累加

**线性（全连接）**：$z^{(l)}=W^{(l)}a^{(l-1)}+b^{(l)}$。
做法：对上一层每个输出分量的每个片段 $(C,\mathbf w,b)$，生成新片段

$$
\bigl(C,\ \tilde{\mathbf w}=W^{(l)}\mathbf w,\ \tilde b=W^{(l)}b+b^{(l)}\bigr),
$$

并对所有来源分量**在同一守卫**下用 $\otimes$（相加）聚合。

**推理态 BN**：$\hat z=\gamma \odot \frac{z-\mu}{\sigma}+\beta$ 是**逐分量仿射**，与线性同法合并入仿射参数。

**残差（Add）**：直接把两支的片段在**守卫交集**上相加（$\otimes$），所得仍为仿射。

> **实现要点**：保持守卫为 H‑形式（$Ax\le d$），在聚合时取**交**；常数/系数累加到 $(\mathbf w,b)$。

### 5.3 ReLU / MaxPool：状态分裂 + 多面体守卫

**ReLU**：$a=\max(0,z)$。若上一层给出 $z$ 的片段 $(C,\mathbf w,b)$，则生成两类子片段：

* **正区**：$\bigl(C\cap \{\mathbf w^\top x + b \ge 0\},\ \mathbf w,\ b\bigr)$；
* **负区**：$\bigl(C\cap \{\mathbf w^\top x + b \le 0\},\ \mathbf 0,\ 0\bigr)$（$\mathbf 0$ 表“常 0 仿射”）。

**MaxPool / N 元 $\max$**：对候选输入 $\{f_i\}$ 的片段集，分别加上**比较守卫**：

$$
C_i^\star\ =\ \Bigl(\bigcap_i C_i\Bigr)\ \cap\ \bigcap_{j\ne i}\ \{\ f_i(x)\ge f_j(x)\ \},
$$

在 $C_i^\star$ 上输出 $f_i$ 对应仿射（其余为 $-\infty$ 或 0）。

> **复杂度注记**：ReLU/Max 是引发“**状态分裂**”的唯一来源；最坏情形片段数指数增长，但共享 DAG 能显著复用子守卫与子仿射。

### 5.4 卷积 / 均值池化：网格变换器与权重共享

* **卷积（Conv）**：对每个输出位置 $(o,i,j)$，卷积是局部仿射和

  $$
  z_{o,i,j}=\sum_{c,u,v} K_{o,c,u,v}\,x_{c,i+u,j+v}+b_o.
  $$

  生成一个**网格变换器**：对每个滑窗中心复制同一**模板**（同一 $\mathbf w,b$ 模式），其**守卫**编码边界/步幅/填充条件。**共享权重**通过**参数别名**实现，不复制数值，仅复制索引。

* **均值池化**：局部无权仿射（平均），与卷积同法但系数均等，同样作为仿射层处理。

> **工程注意**：避免为每个位置复制长向量 $\mathbf w$；用**稀疏张量/稀疏图**存放“（位置，局部偏移）→ 权重索引”。

### 5.5 GNN：固定图上的图变换器（Sum/Mean/Max 聚合 + MLP）

* **聚合（Sum/Mean）**：对节点 $v$，

  $$
  m_v=\sum_{u\in\mathcal N(v)} \alpha_{vu}\,h_u,\quad \alpha_{vu}=1 \text{（Sum）或 }1/|\mathcal N(v)| \text{（Mean）},
  $$

  是**稀疏仿射**，直接按 §5.2 的方式合并。

* **Max 聚合**：在每个 $v$ 上对候选邻居值做 **N 元 $\max$**，用 §5.3 的比较守卫法处理。

* **更新（MLP）**：复用 FFN 编译（仿射 + ReLU），共享参数跨节点作用。最终得到对**整个固定图**的自动机 $A_F(\mathbf X)$。

### 5.6 **SWT‑1（等价性定理）**：$A_F(x)\equiv F(x)$（有守卫前提）

**定理 SWT‑1（等价编译）**
在 A1–A6 下，按 §5.2–§5.5 的规则自底向上编译，所得 $A_F$ 满足
$$
\forall x\in\mathcal D_{\text{in}},\quad A_F(x)=F(x).
$$

**证明要点（构造性归纳）**

* 基层：输入是恒等投影的仿射片段；
* 线性/仿射层：仿射对 CPWL 闭包（AF‑1），权重在 $\otimes$ 下相加，守卫取交；
* ReLU/Max：通过**状态分裂**把门控写成 $\{\text{片段内仿射值}\ge/\le 0\}$ 的线性不等式；对 N 元 Max 加入两两比较守卫；
* 卷积/池化/GNN：按位置/邻域复制模板，等价性逐点成立。
  由结构归纳可得全网等价。

### 5.7 **SWT‑2（无环性与规模）**：DAG ⇒ 无环；节点/守卫数量上界

**命题 SWT‑2（无环）**
若网络计算图为 DAG，按 §5 的编译步骤得到的自动机 $A_F$ 亦为**无环**。

**规模上界（粗估）**
设网络含 $N_{\text{lin}}$ 个仿射子层、$N_{\max}$ 个门控（ReLU/Max/MaxPool），卷积核覆盖数 $H_{\text{conv}}$（含位置复制），则：

* 片段 DAG 的**节点数** $\le c_1(N_{\text{lin}}+H_{\text{conv}})$（共享模板计入）；
* **守卫数**随门控**乘性增长**，最坏 $O(2^{N_{\max}})$，但常因共享/稀疏/对称性显著低于最坏；
* 对 GNN，复制因子为 $|V|$（或边数 $|E|$）的线性因子。

> **复杂度标签**：**构造性**；最坏**指数**于门控数；实践中依赖强共享与剪枝（§5.8、§14）。

### 5.8 工程细节：CSE、稀疏实现、守卫规范形（H‑representation）

* **公共子表达式合并（CSE）**：对重复子图/模板进行指针共享；卷积/GNN 的共享尤为关键。
* **稀疏张量/图**：对卷积/聚合的局部连接，用稀疏结构与索引别名节省内存。
* **守卫规格化**：将所有守卫化到 H‑形式（$Ax\le d$），并做**冗余约束剔除**与**数值稳健化**（阈值、缩放）。
* **片段合并**：当两个片段仿射参数相同且守卫可并（如相邻多面体合并仍为多面体），执行**合并**降低规模。
* **剪枝**：检测**空守卫**（不可行）与**被支配片段**（在其守卫上永不达最优）并删除。
* **接口**：$\texttt{Compile}(\texttt{Net},\ \texttt{Assumptions})\to A_F$；支持分量/中间层输出的**局部编译**。

---

## **第 6 章  自动机层面的等价性、最小化与差异**

### 6.1 **SWT‑3（功能等价可判定）**：无环 SWT 的等价判定

**问题**：给定两个无环 SWT $A_1,A_2$，判定 $\forall x,\ A_1(x)\equiv A_2(x)$。

**定理 SWT‑3（可判定性）**
在守卫为**线性不等式**（多面体），权重为**仿射函数**（或一般 CPWL）的设定下，**等价性可判定**。构造性方法：

1. 计算二者**守卫分割**的**最细共同划分**：对所有片段守卫取交，得有限多面体复形 $\{R_\rho\}$；
2. 在每个 $R_\rho$ 内，二者都退化为**单一仿射式**（或有限 $\max$-of-affine。对有守卫的路径，最优项在区内固定可判定）；
3. 检查每个 $R_\rho$ 上的仿射是否**逐点相等**（即 $\mathbf w_1=\mathbf w_2,\ b_1=b_2$）。全部相等 ⇔ 等价。

**复杂度标签**：**可判定/构造性**；最坏**指数**（共同划分与比较守卫产生组合爆炸）；实践中可用**增量/按需细分**与**SAT‑style 记忆化**（§6.4）。

### 6.2 **SWT‑4（差异区域自动机）**：$\,|F_1-F_2|>\epsilon\,$ 的构造

**目标**：显式刻画
$$
D(\epsilon)=\{x\in\mathcal D_{\text{in}}:\ |A_1(x)-A_2(x)|>\epsilon\}.
$$

**构造**

1. 先构差分函数 $g(x)=A_1(x)-A_2(x)$ 的 SWT（通过积构造与权重求和）；
2. 以阈值 $\epsilon$ 构造两侧集合 $\{g>\epsilon\}$、$\{-g>\epsilon\}$ 的守卫（在每个共同区域内仿射不等式）；
3. 并合两侧，得到**差异区域自动机** $A_{D(\epsilon)}$，其语言即 $D(\epsilon)$。

**意义**：提供**在哪里、差多少**的**精确几何描述**；可直接驱动回归测试/鲁棒性审计/迁移自测。

### 6.3 **SWT‑5（最小实现复杂度）**：最小状态数的定义、存在性与不可易求

**定义（最小实现复杂度）**
对给定函数 $F$ 的无环 SWT 表示的**状态数最小值**记为
$$
\mathrm{MC}(F)\ =\ \min\{|Q|:\ \exists A\text{ 表示 }F\}.
$$

其值定义了 $F$ 在 SWT 模型下的**内在表示下界**。

**命题**

* **存在性**：对有限层 CPWL（满足 A1–A6）的 $F$，$\mathrm{MC}(F)$ 存在（有限）。
* **唯一性**：最小自动机一般**不唯一**（不同守卫划分/共享策略）。
* **求解难度**：寻找 $\mathrm{MC}(F)$ 一般**NP‑难**（至少与最小化布尔/加权电路同级）；实际采用**启发式合并**（§5.8）与**区域同构折叠**。

### 6.4 实践：增量等价检查、差异定位与可视化

* **增量等价**：先做**快速数值回归**（多随机点/对抗点）筛查，再对可疑区域调用 §6.1 的**共同划分 + 仿射一致性**检查；
* **差异定位**：用 §6.2 的 $A_{D(\epsilon)}$ 在输入空间生成**热区地图**（低维切片/投影），回溯到**责任层/责任片段**；
* **可视化**：对每个线性区显示 $(\mathbf w,b)$ 与守卫面，显示“**最优路径**”作为可解释证据；
* **工程接口**：$\texttt{Equivalent}(A_1,A_2)$, $\texttt{DiffRegion}(A_1,A_2,\epsilon)$ 返回“判定 + 证据（共同区域与仿射）”。

---

# **Part III. 函数几何与可微结构**

## **第 7 章  线性区域与决策边界**

### 7.1 **GEO‑1（区域显式构造）**：从 $A_F$ 提取 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$

**目标**
把 CPWL 函数 $F$ 的输出（标量或分量）解析为**有限个线性区域**：
$$
\mathbb R^n=\bigcup_{\rho\in\mathcal R} R_\rho,\qquad
\forall x\in R_\rho:\ F(x)=\mathbf w_\rho^\top x+b_\rho,
$$

并给出每个 $R_\rho$ 的**H‑形式守卫** $C_\rho(x):Ax\le d$。

**构造性算法（概要）**

> 输入：等价自动机 $A_F$（无环），输出：区域表 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$。

1. **路径‑片段生成（上界集）**
   对 $A_F$ 做自顶向下 DFS/BFS。沿路径 $\pi$ 累积：
   守卫 $G(\pi)=\bigcap_{e\in\pi}\mathsf G(e)$，仿射 $f_\pi(x)=\sum_{e\in\pi}\bigl(\mathbf w_e^\top x+b_e\bigr)+c_{\text{src/snk}}$。
   得到候选集合 $\mathcal P=\{(G(\pi),\mathbf w_\pi,b_\pi)\}$。

2. **可行性剪枝**
   用 LP 检查 $G(\pi)$ 是否空集（不可行即丢弃）。

3. **优势性判定（去劣）**
   对任意两条候选 $\pi,\pi'$，在交集 $G(\pi)\cap G(\pi')$ 上解 LP：
   $\max\limits_{x\in G(\pi)\cap G(\pi')} (f_\pi(x)-f_{\pi'}(x))$。
   若最优值 $\le 0$，则 $\pi$ 在该交集中**不可能成为最大**，可对该交进行**区域切除**；若对所有相交对都被切除为空，则整候选删除。

   > 这是把“最大路径”从候选中剥离出真正可能成为**上包络**的一步。

4. **活跃区域刻画**
   对保留的每个候选 $\pi$ 构造其**活跃域**：

   $$
   R_\pi\ =\ G(\pi)\ \cap\ \bigcap_{\pi'\in \mathcal P\setminus\{\pi\}}\ \{\,f_\pi(x)\ge f_{\pi'}(x)\,\}.
   $$

   $R_\pi$ 是多面体（线性不等式的有限交）。若空则略过。

5. **合并与规范化**
   如果两块 $R_{\pi_1},R_{\pi_2}$ 拥有**完全相同的仿射参数** $(\mathbf w,b)$，且 $R_{\pi_1}\cup R_{\pi_2}$ 仍是多面体（或其凸包仍满足同一仿射支配），则合并为更大的区域以减小规模。对每个 $R$ 做 H‑形式去冗余、尺度正规化。

**定理 GEO‑1（区域显式构造，构造性）**
对无环 SWT $A_F$ 存在上述算法，输出有限集合 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$，使得在各 $R_\rho$ 上 $F$ 为相应仿射式；这些区域的并覆盖 $\mathcal D_{\text{in}}$（对实际计算仅需覆盖关心的域）。
**复杂度标签**：构造性；最坏情形指数级（候选路径与比较守卫组合爆炸）；实践中通过剪枝、共享与区域合并显著降低。

**实现要点**

* 守卫以 H‑形式 $Ax\le d$ 存储，统一数值阈值 $\tau$ 做稳定化；
* 优势性 LP 可用**对偶界**快速筛掉大量不相交或明显劣势的对；
* 路径枚举采取**懒惰生成**：仅当某守卫可行且尚未被劣化时，才扩展后继。

### 7.2 **GEO‑2（值域精确计算）**：域内 $\max/\min$ 的分区精确化

**问题**
给定输入域 $\mathcal D$（盒/多面体/$\ell_p$ 球等），精确计算

$$
\max_{x\in\mathcal D}F(x),\qquad \min_{x\in\mathcal D}F(x).
$$

**分区精确法**
由 GEO‑1 得 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$。则

$$
\max_{x\in\mathcal D}F(x)\ =\ \max_{\rho}\ \max_{x\in \mathcal D\cap R_\rho}\ \mathbf w_\rho^\top x+b_\rho,
$$

$$
\min_{x\in\mathcal D}F(x)\ =\ \min_{\rho}\ \min_{x\in \mathcal D\cap R_\rho}\ \mathbf w_\rho^\top x+b_\rho.
$$

每个内层问题是**仿射函数在凸集上的最优化**：

* 若 $\mathcal D\cap R_\rho$ 为**多面体**：转化为 LP；
* 若为 $\ell_\infty$/$\ell_1$ 球：亦为 LP（引入辅助变量）；
* 若为 $\ell_2$ 球：为 SOCP/闭式上界 $b_\rho+\|\mathbf w_\rho\|_2\,\epsilon$（与球心相关）；交上多面体时是 SOCP；
* 其他凸域：可落入通用凸优化。

**定理 GEO‑2（值域精确性）**
在上法中，$\max/\min$ 的结果是**精确值**；当 $F$ **凸**时，可省略区域分割，直接求全局 $\max$-of‑affine 上界（或其对偶）。
**复杂度标签**：构造性；总体代价 =（候选区域数）×（一次 LP/SOCP 代价）；最坏指数，但可并行/可剪枝。

**工程策略**

* **上/下界裁剪**：用 $\|\mathbf w_\rho\|_{p^\ast}$ 与域直径给粗界，低于/高于当前最优即剪枝；
* **分区选择顺序**：先评估梯度范数大的区域、或与域中心距离近的区域；
* **早停**：给定容忍 $\eta$ 做近似最优的停止准则。

### 7.3 **GEO‑3（决策边界复形）**：零水平集为有限多面复形；可抽取完整方程组

**设定**
分类器两类 $i,j$ 的差分函数 $g(x)=F_i(x)-F_j(x)$。由 Part II 的积构造得到其自动机 $A_g$，应用 GEO‑1 获得片段 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$。

**边界构造**
在每个 $R_\rho$ 上，边界片段

$$
B_\rho\ =\ \{\,x\in R_\rho:\ \mathbf w_\rho^\top x+b_\rho=0\,\}
$$

是 $R_\rho$ 与**超平面**的交。全局决策边界

$$
DB_{ij}\ =\ \bigcup_{\rho} B_\rho
$$

是**有限多面复形**（各片段按共有面拼接）。

**定理 GEO‑3（复形与方程组可抽取）**
$DB_{ij}$ 是有限多面复形；其**完整几何方程组**由集合 $\{(R_\rho,\ \mathbf w_\rho^\top x+b_\rho=0)\}$ 给出。
特殊情形：若某 $\mathbf w_\rho=\mathbf 0$，则

* 若 $b_\rho=0$：该区域内**整个** $R_\rho$ 属于边界；
* 若 $b_\rho\ne 0$：该区域对边界**无贡献**。

**复杂度标签**：构造性；规模取决于区域数；可对局部感兴趣的 $\mathcal D$ 限域提取。

**派生能力**

* **边界法向**：$\mathbf n_\rho=\frac{\mathbf w_\rho}{\|\mathbf w_\rho\|_2}$；
* **边界曲率**：CPWL 的边界由**平面片**拼接，曲率集中于拼接的**脊/角**；
* **稳健间隔**：对点 $x_0$ 到最近 $B_\rho$ 的距离 $\frac{|\,\mathbf w_\rho^\top x_0+b_\rho\,|}{\|\mathbf w_\rho\|_2}$，取最小值即**局部边际**。

### 7.4 可视化与下采样策略（高维 → 低维切片/投影）

**切片（Slice）**

* 选基点 $x_0$ 与二维方向 $\mathbf u,\mathbf v$（正交/主成分/梯度导向）；
* 在平面 $\{x=x_0+\alpha\mathbf u+\beta\mathbf v\}$ 网格化采样，调用 $A_F$ 或区域表直接赋值；
* 叠加**区域边界**（守卫或片段等值线）与**决策边界**可视图层。

**投影（Projection）**

* 选子空间 $U$；对每个 $y\in U$ 计算 $\max_{x\in \mathcal D\cap (y+U^\perp)}F(x)$ 或 $\min$，画“上包络/下包络”热图；
* 用于在高维中**守卫并发**情况下的稳定可视化。

**下采样与抗锯齿**

* 在边界附近自适应加密（等值线追踪 / Marching Squares/Cubes）；
* 合理的数值阈值 $\tau$（如 $10^{-7}\sim10^{-5}$）避免浮点误判；
* 对**并发片段**（tie）渲染为**多线/多色**以揭示非可微点。

**输出接口**

* $\texttt{ExtractRegions}(A_F)\to \{(R_\rho,\mathbf w_\rho,b_\rho)\}$；
* $\texttt{DecisionBoundary}(A_F,i,j)\to \{(R_\rho,\mathbf w_\rho,b_\rho)\}_{g=0}$；
* $\texttt{SlicePlot}(A_F;x_0,\mathbf u,\mathbf v,\mathcal D)$ → 图像/矢量图。

---

## **第 8 章  梯度、雅可比与 Lipschitz**

### 8.1 **GEO‑4（梯度自动机）**：与 $A_F$ 同步的梯度发射机制

**目标**
构造一个与 $A_F$ **同步**的变换器 $T_{\nabla F}$，在每个 $x$ 上输出**精确梯度/雅可比**（在可微处），或**次微分**代表（在不可微处）。

**构造**

* 由 GEO‑1 的区域表：在每个 $R_\rho$ 上令

  $$
  \nabla F(x)\equiv \mathbf w_\rho\quad(\text{标量输出}),\qquad
  J_F(x)\equiv J_\rho\quad(\text{向量输出}).
  $$
* 把每个 $(R_\rho,\mathbf w_\rho,b_\rho)$ 作为 **“发射片段”**；形成与 $A_F$ 共享的守卫图，输出为常量向量 $\mathbf w_\rho$ 或矩阵 $J_\rho$。

**非可微点（tie）**
若 $x$ 同时落在多个活跃片段的交上（同值），则 Clarke 次微分

$$
\partial F(x)=\mathrm{co}\{\ \mathbf w_{\rho_1},\dots,\mathbf w_{\rho_k}\ \}
$$

（凸包）。接口可返回：

* **任意选择**（如字典序最小 $\mathbf w$）；
* **最小范数次梯度**（凸 QP）；
* **全集合 H‑表示/极点集**（用于理论分析）。

**定理 GEO‑4（梯度/雅可比自动机）**
存在构造性算法给出 $T_{\nabla F}$，使得对 a.e. $x$，其输出等于 $\nabla F(x)$（或 $J_F(x)$）。在不可微点返回的集合包含 Clarke 次微分。
**复杂度标签**：构造性；规模与区域数同阶；可共享守卫与稀疏存储。

**工程注意**

* 存储雅可比时按**块稀疏**（卷积/聚合结构）保存；
* 数值阈值 $\tau$ 判定“tie”；
* 可提供**方向导数**接口：$dF(x;\,v)=\max_{g\in \partial F(x)} g^\top v$。

### 8.2 **GEO‑5（全局/局部 Lipschitz 精确值）**

**陈述**

* **标量输出** $F:\mathbb R^n\to\mathbb R$：

  $$
  L_p(F)\ =\ \max_{\rho}\ \|\mathbf w_\rho\|_{p^\ast}.
  $$
* **向量输出** $F:\mathbb R^n\to\mathbb R^m$：给定输入 $\ell_p$、输出 $\ell_r$

  $$
  L_{p\to r}(F)\ =\ \max_{\rho}\ \|J_\rho\|_{p\to r}.
  $$
* **局部/域内**（$\mathcal D\subseteq\mathbb R^n$）：把最大取值限制在 $\{\rho:\ R_\rho\cap\mathcal D\neq\varnothing\}$。

**证明要点**
CPWL 在每个区域的梯度/雅可比常值；全局 Lipschitz 常数是各区域**对偶范数**或**算子范数**的最大值（Clarke 广义梯度上界在 CPWL 情形恰为“区域最大”）。

**算子范数计算**

* $p=r=2$：$\|J_\rho\|_{2\to 2}$ 为**谱范数**（最大奇异值），可用幂迭代（少次迭代即可，因 $J_\rho$ 常为稀疏/结构化）；
* $p=1,r=1$：列和最大；$p=\infty,r=\infty$：行和最大；
* $p=1,r=\infty$、$p=\infty,r=1$ 等可转 LP（小规模时精确，大规模时近似）。

**定理 GEO‑5（精确 Lipschitz）**
在区域表可得的前提下，上式给出的 $L_p,L_{p\to r}$ 为**精确值**；当限制域 $\mathcal D$ 时，取穿域区域的最大值即得**域内精确常数**。
**复杂度标签**：构造性；总体代价 =（相关区域数）×（一次范数计算代价）。

**实践策略**

* **快速上界**：不枚举区域时，用**层范数组合上界**（如 $\prod\|W_l\|_{p\to p}$）做预筛；
* **增量逼近**：先在抽样点识别对应区域，更新当前最大；再对“高梯度邻域”优先精确计算；
* **缓存**：把 $\|\mathbf w_\rho\|_{p^\ast}$/$\|J_\rho\|$ 记入区域表，供 7.2/鲁棒性验证复用。

### 8.3 计算与缓存：区梯度表、极值候选裁剪、数值健壮性

**区域‑梯度表（RGT）**

* 结构：$(\text{id}_\rho,\ C_\rho:Ax\le d,\ \mathbf w_\rho,b_\rho,\ \|\mathbf w_\rho\|_{p^\ast},\ \|J_\rho\|_{p\to r})$；
* 支持操作：**命中测试**（点是否落入 $C_\rho$）、**相邻查询**（通过守卫面对集合）、**合并**（同仿射同法向）。

**极值候选裁剪**

* 使用**对偶范数上界**：若 $\sup_{x\in\mathcal D\cap C_\rho} \mathbf w_\rho^\top x+b_\rho$ 的快速上界低于当前最优，则剪；
* 维护**优先队列**：按上界排序，分支‑界定式求精确值。

**数值健壮性**

* 守卫冗余剔除：用 LP 检查每条不等式是否由其他不等式隐含；
* 守卫缩放：将 $Ax\le d$ 的行做归一化，避免病态条件数；
* 判等阈值：向量范数/仿射参数比较用 $\tau$，避免虚假碎片化；
* Rational/高精度可选：在关键证明/验证步骤采用分数或任意精度算术。

---

# **Part IV. 验证、等变与因果**

## **第 9 章  形式化性质与产品构造验证**

### 9.1 性质规格语言（阈值/区间/多面体/正则组合）

**目标**
为常见“安全/鲁棒/有界/分类正确/输出单调性”等性质提供**可编译的规格语言** $\mathcal L_\Phi$，并将每个性质 $\phi\in\mathcal L_\Phi$ 编译为**性质自动机**或**性质变换器** $A_\phi$ / $A_{\neg\phi}$。

**基本原子**（均可在 SWT 守卫 + 权重不等式中表达）

* **输入域约束**：$x\in \mathcal D$（盒、$\ell_p$ 球、多面体）。
* **输出阈值**：$F_k(x)\le \tau$, $F_k(x)\ge \tau$。
* **分类正确**：$\arg\max_i F_i(x)=y$ ⇔ $\bigwedge_{j\ne y} F_y(x)-F_j(x)\ge 0$。
* **间隔/裕度**：$F_y(x)-\max_{j\ne y}F_j(x)\ge \gamma$。
* **区间约束**：$\ell_k \le F_k(x) \le u_k$。
* **关系型**（两输入比较）：$F(x)-F(x')\le \epsilon$（Lipschitz 局部性/稳定性）、单调性 $x\le x' \Rightarrow F(x)\le F(x')$。

**正则组合**

* 布尔：$\wedge,\ \vee,\ \neg$。
* 量化：$\forall x\in \mathcal D\; \phi(x)$, $\exists x\in \mathcal D\; \phi(x)$（验证常落在 $\forall$）。
* 本书将 $\forall$ 验证归约为**反例搜索为空**（§9.2）。

**编译思路**

* 对于涉及输出不等式的性质，构造**差分函数**（如 $g=F_y-\max_{j\ne y}F_j$ 或 $g=F_k-\tau$），并以 $g<0$（或 $>0$）为**反例条件**；
* 将域约束/输出比较转为**守卫**或**附加线性不等式**；
* 得到**反例自动机** $A_{\neg\phi}$（识别使性质失效的输入集合）。

### 9.2 **VER‑1（属性验证）**：$A_{cex}=A_F\circ A_{\neg\phi}$，空性 ⇔ 满足

**定理 VER‑1（产品构造验证）**
设网络自动机 $A_F$ 与性质的反例自动机 $A_{\neg\phi}$ 在同一函数半环 $K_f$ 与守卫语言下可表示，令

$$
A_{cex}\ :=\ A_F\circ A_{\neg\phi}.
$$

若 $L(A_{cex})=\varnothing$（无可行路径/区域），则 $\forall x\in\mathcal D$ 满足 $\phi$；否则 $A_{cex}$ 的任一可行路径给出**反例区域**，可提取具体反例点。

**算法（构造性）**

1. **编译** $A_F$（第 5 章）与 $A_{\neg\phi}$（按 9.1）；
2. **复合**：守卫取交，权重按 $\otimes$ 相加；
3. **空性检查**：对每条从初始到终止的路径，检查守卫可行性（LP/SOCP）；如涉及输出阈值/比较，落在差分仿射的线性不等式上；
4. **反例抽取**：若可行，解一次 LP 得到具体 $x^\star$。

**复杂度标签**

* **可判定/构造性**；
* 最坏**指数**（路径/守卫组合）；每次可行性为 LP/SOCP/MILP（取决于域与 $\ell_p$）；
* 实践：**增量‑按需**复合 + **冲突守卫学习** + **区域缓存**（§6.4, §8.3）。

### 9.3 **VER‑2（鲁棒性认证）**：邻域 $B_p(x_0,\epsilon)$ 的精确判定

**目标**
判断在 $B_p(x_0,\epsilon)$ 内，性质（如分类不变/裕度 $\ge\gamma$）是否成立；若不成立，给出最小扰动反例。

**方法 A：区域分割法（精确）**

* 用 GEO‑1 得 $\{(R_\rho,\mathbf w_\rho,b_\rho)\}$；只保留与球/盒有交的区域；
* 对每区域求差分函数 $g$ 的**最小值**：

  $$
  \min_{x\in R_\rho \cap B_p(x_0,\epsilon)} g(x)\quad
  (\text{LP/SOCP，取决于 }p) ;
  $$
* 若所有区域最小值 $\ge 0$，则**鲁棒**；否则取全局最小值的点为反例。

**方法 B：MILP 一体化（适合 $p\in\{1,\infty\}$ 与盒）**

* 直接把门控（ReLU/Max）与域约束编码为 MILP；
* 目标 $\min g(x)$ 或 $\min\|x-x_0\|_p$ s.t. $g(x)\le 0$；
* 得到精确结论，但规模随层数与门控指数增长。

**定理（鲁棒性可判定）**
在 CPWL 与凸域（盒/$\ell_p$ 球/多面体）下，鲁棒性问题**可判定**且上述两种方法给出**精确结果**。
**复杂度标签**：构造性；最坏指数；可并行/剪枝。

**产出**

* “局部认证证书”：最小 $g$ 值与见证点；
* “最小对抗范数”：$\min\{\|x-x_0\|_p : g(x)\le 0\}$。

### 9.4 反例生成与分布化展示

**点级反例**

* 从 $A_{cex}$ 或 §9.3 的最小化问题取**可行解**；
* 可加目标正则（最小 $\|x-x_0\|_p$ 或最小变化稀疏度）。

**区域级反例**

* 输出反例**多面体片段** $R_{\text{cex}}$（守卫交且满足 $g<0$ 的子域），并给出其体积/测度估计（在盒内的比例）。

**分布化展示**

* 在输入域的低维切片上渲染**反例热图**；
* 按层/按片段回溯**责任路径**（哪个 ReLU/Max 决策导致违例）；
* 生成**最接近反例**集（top‑K minimal‑perturbation）。

---

## **第 10 章  对称与等变（平移/置换等）**

### 10.1 变换器 $\mathcal T_g,\mathcal T_{g'}$ 的 SWT 表示

**输入变换** $g:\mathcal D_{\text{in}}\to \mathcal D_{\text{in}}$（如平移/置换/翻转）与**输出变换** $g':\mathbb R^m\to\mathbb R^m$（如通道/类的同步置换或空间平移）。

* **CNN 平移**：$\mathcal T_g$ 在输入网格上执行**索引重映射**（带边界守卫：填充/裁剪）；$g'$ 对特征/输出图做相同位移（考虑 stride/下采样时的别名）。
* **GNN 置换**：$\mathcal T_\pi$ 是节点索引置换；$g'=\pi$ 在输出节点维度上置换。SWT 实现为**重命名**与邻域守卫重定向。
* **一般线性变换**：若为整数格子上的可逆映射（翻转/旋转 90°），守卫通过坐标仿射重写。

**实现注记**

* 边界效应（padding）打破严格等变，需要把**有效感受野内**的子域作为守卫；
* stride/池化造成**采样别名**，严格等变性需配合相应的 $g'$（如整除关系）。

### 10.2 **VER‑3（等变验证）**：$A_F\circ \mathcal T_g \equiv \mathcal T_{g'}\circ A_F$

**定理 VER‑3（等变验证 = 等价判定）**
给定 $g,g'$ 的 SWT 表达，验证

$$
A_F\circ \mathcal T_g\ \equiv\ \mathcal T_{g'}\circ A_F
$$

等价于对两个无环 SWT 的**等价判定**（SWT‑3）。若不等价，差异自动机（§6.2）直接给出**破坏等变的输入区域**与**误差幅度**。

**复杂度标签**

* 可判定；最坏指数；
* 实践用**共同守卫细化 + 局部对齐**：先在“远离边界”的**有效域**上检查（常成立），再把差异局限在边界。

### 10.3 典型族：CNN 平移等变、GNN 置换等变；何时可判定/可实现

**CNN 平移等变（典型条件）**

* 卷积 stride = 1，padding 为**平移相容**（如周期/延拓）；无随机/数据相关算子；
* 若含下采样（stride>1 或 pool），则等变性对**子格平移**成立；否则需在 $g'$ 上同步缩放/取样。
  **实现**：$\mathcal T_g$ 为输入平移 + 边界守卫；$\mathcal T_{g'}$ 为输出平移。验证于**有效域**。

**GNN 置换等变（MPNN 家族）**

* 聚合算子**对称**（Sum/Mean/Max）；共享权；更新为逐节点 MLP。
* $\mathcal T_\pi$ 仅重命名节点；$g'=\pi$。
  **实现**：SWT 通过**邻域索引置换**；验证于固定图 $G$。

**可判定/可实现**

* 当 $g,g'$ 可编为 SWT 且网络满足 A1–A6，**可判定**；
* 边界/下采样需限制到**有效子域**，否则反例必存。

### 10.4 偏差挖掘：期望等变性被破坏的定位方法

**流程**

1. 运行 VER‑3，若不等价，得到 $A_D$（差异区域自动机）；
2. **分解到层**：对每一层 $l$，比较 $\mathcal T_{1:l}\circ \mathcal T_g$ 与 $\mathcal T_{g'}\circ \mathcal T_{1:l}$，定位最早出现差异的层；
3. **定位到片段**：在该层的守卫与片段上找出导致差异的**门控决策**；
4. **修复建议**：添加/调整 padding、改 stride、在损失中加入等变正则，或用 §12–13 的参数/结构修复。

**产出**

* 一组“破坏等变”的**责任路径**与**输入模式**；
* 自动生成的“**最小改动建议**”（例如：把 stride 从 2 改 1 + 后续平均池化）。

---

## **第 11 章  因果干预与反事实分析**

### 11.1 干预语法：节点/滤波器/共享维度

**干预测律（do‑operator）**

* **FFN 节点级**：$\texttt{do}(a^{(l)}_k \leftarrow P_c)$，把第 $l$ 层第 $k$ 个激活替换为给定 CPWL $P_c(x)$。
* **CNN 滤波器级**：$\texttt{do}(A^{(l)}_{k,:,:} \leftarrow P_{C,k})$，整个特征图替换为 CPWL 张量函数。
* **GNN 共享维度**：$\texttt{do}(h^{(l)}_{v,k} \leftarrow P_{C,k}\ \forall v\in V)$（同一维对全图共享干预）。
* **门控/阈值**：也可把某 ReLU 门的阈值偏置化为 $t$：$\max(0,z-t)$（仍 CPWL）。

**语义**

* 产生**干预后模型** $F_C$：把相应子图替换为**外部端口**（由 $P_c$ 提供值），并向后传播；
* 在 SWT 中等价于**替换子变换器**为“恒定/给定”的 CPWL 片段生成器。

### 11.2 **CAU‑1（干预保持 CPWL）**：替换仍 CPWL，差分仍 CPWL

**定理 CAU‑1（闭包）**
在 A1–A6 下，若干预子表达式 $P_c$ 为 CPWL，则干预后函数 $F_C$ 仍为 CPWL；差分 $g_C(x)=F(x)-F_C(x)$ 也是 CPWL。其 SWT 表示可通过**局部替换并复合**构造得到。

**证明要点**

* CPWL 在仿射与 $\max$ 下闭包（AF‑1）；
* 替换是 DAG 内的**子图替换**，不引入环；
* 差分为两个 CPWL 的差，仍 CPWL。

### 11.3 **CAU‑2（最大因果影响）**：$\sup_{\mathcal D}|F-F_C|$ → MILP/分区精确解

**目标**
量化干预 $C$ 对输出的影响：

$$
I_{\max}(C;\mathcal D)\ :=\ \sup_{x\in\mathcal D}\ |F(x)-F_C(x)|.
$$

**方法 A：区域分割（精确）**

* 用 GEO‑1 分别提取 $F$ 与 $F_C$ 的区域表，或直接对差分 $g_C$ 提取；
* 在每个交叠区域 $\tilde R$ 上解

  $$
  \max_{x\in \mathcal D\cap \tilde R} |\,\mathbf w^\top x+b\,|
  $$

（等价于两次仿射最大化）；

* 取所有区域的最大值即 $I_{\max}$。

**方法 B：MILP 一体化**

* 把 $|\cdot|$ 引入**裂变变量**，以 $\max(u,-u)$ 的标准线性化处理；
* 目标 $\max |g_C(x)|$，约束含门控二值变量与域约束。
* 适合复杂网络/域为盒/$\ell_\infty$。

**产物**

* $I_{\max}$ 的**精确数值**；
* **最致命输入** $x^\star$（达上界的点）；
* 若分量输出，给出每分量的影响谱 $\{I_{\max}^{(k)}\}$。

**复杂度标签**

* 可判定/构造性；最坏指数；可并行/剪枝。

### 11.4 解释与审计：S‑ICE / NF‑ICE 的全域/局部报告与热图

**指标**

* **S‑ICE**（结构化个体因果效应，CNN‑滤波器）：

  $$
  \text{S‑ICE}_k(x)\ =\ F(x)\ -\ F_{\,\texttt{do}(A^{(l)}_{k}\leftarrow 0)}(x).
  $$
* **NF‑ICE**（节点特征因果效应，GNN‑共享维度）：

  $$
  \text{NF‑ICE}_k(x)\ =\ F(x)\ -\ F_{\,\texttt{do}(h^{(l)}_{v,k}\leftarrow 0,\ \forall v)}(x).
  $$
* **汇总**：对 $\mathcal D$ 求 $\sup/\mathbb E/\text{quantile}$ 以得全域影响谱；对单样本 $x_0$ 给出**局部热图**（空间/节点维度）。

**可视化**

* CNN：在特征图/输入像素上渲染 $\text{S‑ICE}_k$；
* GNN：在图上渲染 $\text{NF‑ICE}_k$（节点大小/颜色）；
* 报告**top‑K 重要滤波器/特征维**与其 $I_{\max}$，附带最致命输入例。

---

# **Part V. 修复、综合与工程化**

## **第 12 章  参数修复与综合**

### 12.1 **SYN‑1（参数修复的半代数化）**

**问题**
已训练网络 $F_W$ 违反目标性质 $\Phi$。希望在**尽量小的参数改动** $\Delta W$ 下，得到满足 $\Phi$ 的新模型 $F_{W+\Delta W}$。

**形式化构建**

$$
\boxed{\;
\min_{\Delta W}\ \|\Delta W\|_p
\quad\text{s.t.}\quad
A_{W+\Delta W}\ \models\ \Phi
\;}
\tag{12.1}
$$

其中 $A_{W+\Delta W}$ 为按第 5 章编译得到的 SWT，$\Phi$ 用第 9 章的规格语言编译成性质自动机/变换器。

**可解性与语义**

* **可判定**：$\Phi$ 为由线性不等式和 $\max$/加法组合的性质；
* **半代数化**：把“$A_{W+\Delta W}\models\Phi$”转为关于 $W+\Delta W$ 的有限组**多项式（含分段）不等式**；
* **复杂度标签**：可判定但在最坏情形**不可行**（指数级守卫/区域 + MILP/MICP）；需工程化策略。

**三条求解路线（互补）**

1. **CEGIS / 反例驱动的剪切平面**

   * 迭代流程：

     * 给定候选 $\Delta W$ → **验证**（第 9 章）：若通过则结束；
     * 若失败，从 $A_{cex}$ 抽取**反例区域/点** $\mathcal R_{\text{cex}}$；
     * 仅对这些区域/点添加**线性/凸**约束，更新（12.1）。
   * 直到无反例为止。
   * **优点**：无需枚举全域守卫；**全程可证**：若终止即保证满足 $\Phi$。

2. **直接 MILP/MICP（小中规模/局部域）**

   * 把 ReLU/Max 编为二值变量与 big‑M/指示约束；
   * 约束 $\Phi$（如最小裕度、鲁棒球内分类不变）直接写入；
   * **适用**：输入域为盒/$\ell_\infty$，或鲁棒半径小；网络浅/窄。
   * **优点**：一次求得全局可行解；**劣势**：规模增大时难解。

3. **罚项同伦（Penalty Homotopy）/近似求解**

   * 构造可微/次可微的**违例度** $V_\Phi(W)$（如分类 margin 的铰链损失），用 GEO‑4 的**精确梯度**；
   * 最小化 $\lambda\,V_\Phi(W+\Delta W)+\|\Delta W\|_p$，逐步**增大 $\lambda$**（同伦），每步 warm‑start；
   * 验证环节裁判“是否已满足”，否则继续。
   * **优点**：可扩展、可与一阶优化对接；**劣势**：不保证一步达可行，需要外层验证兜底。

> **实现建议**：在 1) 与 3) 之间做**双环**：外层 CEGIS ；内层用罚项同伦快速产生候选 $\Delta W$。

### 12.2 **SYN‑2（由规范到最小范数权重）**

当仅给定**目标规范** $\Phi$（例如“平移等变”“Lipschitz 常数 $\le L_0$”“最小裕度 $\ge \gamma$”）而**无初始权重**时，直接寻找 $W^\star$：

$$
\boxed{\;
\min_{W}\ \|W\|_p
\quad\text{s.t.}\quad
A_{F_W}\ \models\ \Phi
\;}
\tag{12.2}
$$

**示例约束转写**

* **等变性**（第 10 章）：$A_{F_W}\circ \mathcal T_g \equiv \mathcal T_{g'}\circ A_{F_W}$
  → **SWT 等价**约束（SWT‑3）在 CEGIS 框架下迭代施加。
* **全局 Lipschitz $\le L_0$**（GEO‑5）

  * **精确但难**：对所有线性区域 $\rho$，$\|J_\rho(W)\|_{p\to r}\le L_0$（区域依赖于 $W$）。
  * **实用松弛**：层范数约束 $\prod_l \|W_l\|_{p\to p}\le L_0$（对 $p=2$ 可用谱范数；可用 SDP/MICP 或谱归一化近似），作为**充分条件**。
* **最小裕度 $\ge \gamma$**：在 $\mathcal D$ 上要求 $g(x)=F_y(x)-\max_{j\ne y}F_j(x)\ge \gamma$
  → CEGIS + 反例区域 LP/SOCP 约束。

**优化策略**

* **分层正则**：$\sum_l \alpha_l\|W_l\|_p$ 避免权重集中；
* **结构先验**：卷积权共享 + 稀疏先验（$\ell_1$/group‑lasso）；
* **早期裁剪**：先满足易解的**充要近似**（层范数/LMI），再逐步细化到精确约束。

### 12.3 复杂度与实用化：松弛（LP/MILP/MICP）、温启动、罚项同伦

**复杂度与标签**

* 本章任务总体为**可判定**但**计算上困难**（NP‑难/指数级）；
* 采用**分解**（区域/守卫的按需细化）、**松弛**（层范数上界）、**验证‑合成双环**提升实用性。

**工程策略清单**

1. **松弛族**

   * ReLU/Max：big‑M ↔ 指示约束 ↔ 紧的三角松弛（triangle relaxations）；
   * Lipschitz：谱范数/行列和上界；
   * 等变性：仅在**有效域**（远离边界/stride 对齐子格）先验满足。

2. **温启动**

   * 从当前 $W$ 的小扰动开始；
   * 对 MILP 使用解的**基/割平面**热启动；
   * 对同伦，$\lambda$ 指数增长并重用上一步优化器状态。

3. **剪枝与切割平面**

   * 只对**反例区域**施加约束；
   * 用**对偶界**（GEO‑2/5）过滤弱约束；
   * 在线生成**冲突守卫**（不可行的守卫组合）。

4. **并行与缓存**

   * 区域/候选对的 LP/SOCP/MILP 并行求解；
   * 缓存区域的仿射参数与范数、已检验的不可行守卫。

---

## **第 13 章  结构修复与最小编辑**

### 13.1 原子编辑算子集（面向 SWT/网络双视角）

**算子集合 $\mathcal O$**（保持 CPWL/DAG 前提）

* **拓扑类**：增/删层，新增残差，改变连接（不引入环）；
* **算子替换**：MaxPool ↔ AvgPool；ReLU ↔ Leaky‑ReLU/PReLU（参数可控）；
* **超参修改**：卷积 stride/padding/kernel 大小（须同步调整守卫）；
* **剪枝**：删神经元/滤波器/边（GNN），或置零其权（仍 CPWL）；
* **归一化**：训练态 BN → 推理态 BN（固定统计量）；
* **共享化/解共享**：对 GNN/CNN 的参数共享开关（仍在 CPWL 范畴内）。

**在 SWT 上的等义操作**

* **节点/边编辑**：增删转移、修改守卫 $Ax\le d$、替换权重函数（仿射参数）；
* **模板操作**：对卷积/聚合模板做参数化修改并**全域同步**；
* **保证**：所有算子保持**无环**与**守卫的线性**，从而编译闭包。

### 13.2 **SYN‑3（最短编辑求解）**

**问题**
在算子集 $\mathcal O$ 上寻找最短编辑序列 $S$，使编辑后模型满足 $\Phi$：

$$
\boxed{\;
\min_{S\in\mathcal O^\ast}\ \text{len}(S)
\quad \text{s.t.}\quad
A_{S(F)}\ \models\ \Phi
\;}
\tag{13.1}
$$

**思路一：A\* on 等价类（启发式搜索）**

* **状态**：当前模型 $F^{(t)}$ 的 SWT 表示 $A^{(t)}$；
* **动作**：应用某个原子算子 $o\in\mathcal O$ 得到 $A'$；
* **代价**：步长 1（或按编辑类型赋权）；
* **启发函数 $h(A)$**：

  * 由 **差异自动机**（§6.2）/ **反例自动机**（§9.2）给出**当前违例度**（如最小裕度缺口、最大等变偏差）；
  * 参考 **灵敏度/责任路径**（WFA‑15/Part IV）：对可能修复的局部编辑评估**上限影响**，形成**可达改进上界**；
* **判定**：每步用快速验证（第 9 章）过滤；找到满足 $\Phi$ 的最短路径即解。

**思路二：混合整数选择（剪枝/替换）**

* 对一族候选编辑引入二值变量 $z_i\in\{0,1\}$（是否应用）；
* 目标 $\min \sum_i z_i$；
* 约束 $\Phi$ 在“编辑后的模型”上成立（通过把受影响的子图语义用 $z_i$ 的**凸包/Big‑M** 表达）；
* 适用于**有限离散候选**（例如“从 $k$ 个 pooling 位置中选择 $s$ 个替换为 AvgPool”）。

**CEGIS‑S（反例驱动的结构搜索）**

* 外层与 12.1 相同：失败时从反例自动机提取**最小责任子图**；
* 内层在该子图上限制**候选编辑集合**，大幅降低分支。

**复杂度与保证**

* A\*：若启发函数**一致**（低估真实代价），返回**全局最短**；
* MILP：对离散候选给出**全局最优**（可证），规模受限；
* CEGIS‑S：终止即满足 $\Phi$，但不保证最短（可加入长度上界/回溯）。

### 13.3 搜索策略：A\* on 等价类、SWT 片段复用、反例驱动

**策略库**

1. **候选生成**：

   * 用**责任路径**定位关键 ReLU/Max/卷积核；
   * 生成一阶候选：降低 stride、改 padding、Max→Avg、加残差、剪枝噪声激活等。

2. **影响上界**：

   * 使用 **CAU‑2** 的 $I_{\max}$ 作为单次编辑的**上界效应**；
   * 对序列编辑，使用次可加上界进行**束搜索**。

3. **共享复用**：

   * 在 SWT 层直接改**模板**，同步影响所有位置/节点，减少搜索深度；
   * 在 GNN 上优先对**共享维度**编辑（影响全图）。

4. **多目标折衷**：

   * 若同时追求“修复 + 精度保持”，把验证集损失作为**软约束**或二级目标；
   * A\* 的代价函数可设为 $\alpha\cdot \text{len}(S)+\beta\cdot \text{acc\_drop}$。

---

## **第 14 章  实现、规模化与案例**

### 14.1 数据结构：守卫的 H‑形式、区域缓存、共享 DAG

* **守卫 H‑形式**：统一存储为 $Ax\le d$；行规范化与冗余剔除（LP 检查）；
* **共享 DAG**：片段（守卫，$\mathbf w,b$）以**哈希键**（量化后）去重；卷积/GNN 使用**模板别名**；
* **区域缓存（RGT）**：保存 $(R_\rho,\mathbf w_\rho,b_\rho)$ 与范数/可行性状态，供 GEO‑2/5、VER‑2 复用；
* **守卫索引**：按面/相邻关系建稀疏图，加速相邻查询与可视化。

### 14.2 规模化技巧：剪枝/对偶界、切割平面、分区并行、稀疏 BLAS

* **剪枝与上界**：

  * 用 $\|\mathbf w_\rho\|_{p^\ast}$ 与域直径给**快速上界**；
  * “被支配片段”删除：在交域上永不成为 $\max$ 的片段直接剔除。
* **切割平面/分解**：

  * 对鲁棒/裕度约束，用**分区切割平面**（仅对活跃/反例区域加约束）；
  * 对大 MILP，使用**Benders/Outer‑Approx**。
* **并行**：

  * 区域级/路径级并行；
  * GPU/稀疏 BLAS 评估大批仿射/梯度。
* **数值稳健**：

  * 守卫公差 $\tau$，仿射参数量化；
  * 重要证明步骤使用高精度算术（可选）。

### 14.3 三类案例：端到端流程（概述）

1. **小型 FFN（UCI 级）**

   * 任务：局部鲁棒性（$\ell_\infty$ 半径 $\epsilon$）+ 最小修复 $\Delta W$。
   * 流程：Compile → Verify(VER‑2) → 若失败：SYN‑1（CEGIS+MILP 小域） → 复验 → 证书（反例闭包 + $\Delta W$ 范数）。

2. **轻量 CNN（CIFAR‑like）**

   * 任务：平移等变（子格位移）+ 分类裕度 $\gamma$。
   * 流程：Compile → Equivariance(VER‑3，有效域) → 发现边界偏差 → EditSynthesize（Max→Avg 于边界层 / padding 调整） → 复验 + 精度回归测试。
   * 附加：用 GEO‑3 可视化边界切片变化。

3. **固定图 GNN（节点分类）**

   * 任务：置换等变 + 对抗特征局部鲁棒。
   * 流程：Compile(G) → Equivariance(VER‑3: $\pi$) → 若违例，结构修复（聚合替换/共享权约束） → NF‑ICE 分析共享维的因果影响 → 最终验证。

### 14.4 局限与风险：指数区域、量词消去代价、数值稳健性与容错

* **指数区域**：片段数在最坏情形指数级；通过共享/剪枝/区域抽样缓解，但**仍是核心挑战**。
* **量词消去/全域性质**：全局 $\forall x$ 约束若不经 CEGIS，直接求解代价**爆炸**；推荐**反例驱动**。
* **不可微点与数值**：tie 区域的判等阈值影响边界估计；需健壮参数。
* **适用范围**：不覆盖注意力/乘法门/循环/随机层；若必须支持，需使用**近似**或**外包黑盒验证**。
* **工程容错**：提供“超时‑返回当前最佳证据”的策略（近似证书 + 反例日志）。